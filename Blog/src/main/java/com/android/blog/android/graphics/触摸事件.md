å½“æˆ‘ä»¬æŒ‰ä¸‹å±å¹•åï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆä¼ é€’åˆ°åº”ç”¨çš„ï¼Ÿ

Android æ˜¯ä¸€ä¸ªæœ‰ç”¨æˆ·ç•Œé¢ï¼ˆ*GUI*ï¼‰çš„æ“ä½œç³»ç»Ÿï¼Œåœ¨å®ƒè¯ç”Ÿä¹‹åˆï¼Œå°±æ˜¯ä¸ºå¸¦æœ‰è§¦æ‘¸å±çš„æ‰‹æŒè®¾å¤‡å‡†å¤‡çš„ã€‚å› æ­¤ï¼Œè§¦æ‘¸å±ä½œä¸ºæä¾›ç»™ç”¨æˆ·æœ€é‡è¦çš„äº¤äº’æ–¹å¼ä¹‹ä¸€ï¼Œäº†è§£å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå¯¹äºå®é™…çš„é¡¹ç›®å¼€å‘æœ‰ç€éå¸¸å¤§çš„å¸®åŠ©

æœ¬ç¯‡æ˜¯å›¾å½¢ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ï¼Œåœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«äº†è§£äº† Android ç³»ç»Ÿ[[æ¸²æŸ“/åˆæˆçš„åº•å±‚åŸç†]](https://juejin.cn/post/7132777622487957517)å’Œ[[è‡ªå®šä¹‰ View / ViewGroup çš„æµç¨‹]](https://juejin.cn/post/7140332948485570596)

ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå›¾å½¢ç³»ç»Ÿä¸­ï¼Œå¦ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼š**äº‹ä»¶åˆ†å‘**

å’Œä»¥å¾€ç›¸æ¯”ï¼Œä»Šå¤©çš„æ–‡ç« ä¼šç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ä¸ä¸€æ · ğŸ¤ğŸ»

æˆ‘ä»¬ä¼šä»è®¤è¯†ç¡¬ä»¶é©±åŠ¨å¼€å§‹ï¼Œè‡ªåº•å‘ä¸Šï¼Œä¸€æ­¥æ­¥çš„æ¥äº†è§£ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆåˆ°è¾¾çš„ç³»ç»Ÿå†…æ ¸ï¼Œå†…æ ¸åˆæ˜¯æ€ä¹ˆä¼ é€’åˆ°åº”ç”¨ï¼Œä»¥åŠåº”ç”¨æœ€ç»ˆæ˜¯å¦‚ä½•æ¶ˆè´¹æ‰äº‹ä»¶çš„

åºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ï¼Œlet's go

> *å‰æ’æé†’ï¼šå…¨æ–‡ 1.5w å­—ï¼Œå»ºè®®é˜…è¯»æ—¶é•¿ 30 åˆ†é’Ÿ*

![android_graphic_v5_overview](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_overview.png)

# ä¸€ã€è§¦æ‘¸äº‹ä»¶çš„èµ·æºï¼ˆLinux Kernelï¼‰

Android è¾“å…¥äº‹ä»¶çš„ç±»å‹ï¼Œå’Œåˆ†å‘çš„æµç¨‹éƒ½æ¯”è¾ƒå¤æ‚ï¼Œé™¤äº†è§¦æ‘¸äº‹ä»¶å¤–ï¼Œç³»ç»Ÿè¿˜æœ‰æ¥è‡ª`é¼ æ ‡`ã€`é”®ç›˜`ã€`éŸ³é‡é”®`ã€`ç”µæºé”®`ç­‰å…¶ä»– Input è®¾å¤‡çš„äº‹ä»¶éœ€è¦å¤„ç†

æˆ‘ä»¬æ—¥å¸¸å¼€å‘æ¥è§¦æ¯”è¾ƒå¤šçš„æ˜¯ â€˜è§¦æ‘¸äº‹ä»¶â€™ï¼Œå› æ­¤ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºçš„æ˜¯ â€˜è§¦æ‘¸äº‹ä»¶â€™ çš„åˆ†å‘æµç¨‹ï¼Œå…¶ä»–ç±»å‹çš„è¾“å…¥äº‹ä»¶é¡ºå¸¦ä¼šæä¸€å˜´ï¼Œä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹

æœ¬æ–‡ä¸€å…±åˆ†ä¸ºä¸‰å¤§éƒ¨åˆ†ï¼š

ç¬¬ä¸€éƒ¨åˆ†ä»‹ç» â€˜`è§¦æ‘¸äº‹ä»¶çš„èµ·æº`â€™ ï¼Œä¸»è¦è®²çš„æ˜¯é©±åŠ¨ä¸ŠæŠ¥åŸå§‹äº‹ä»¶ï¼Œå†…æ ¸è§£æåŸå§‹äº‹ä»¶å¹¶ä¿å­˜åˆ°è®¾å¤‡æ–‡ä»¶ä¸­ï¼Œä»¥ä¾› Framework è¯»å–åˆ†å‘

ç¬¬äºŒéƒ¨åˆ†ä»‹ç» â€˜`è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’`â€™ ï¼Œä¸»è¦è®²çš„æ˜¯ InputManagerService æ€ä¹ˆæŠŠäº‹ä»¶ä¼ é€’åˆ°åº”ç”¨è¿›ç¨‹ï¼Œå¹¶åˆ†å‘ç»™ç›®æ ‡ Window

ç¬¬ä¸‰éƒ¨åˆ†ä»‹ç» â€˜`è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹`â€™ ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”ç”¨å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„äº‹ä»¶åˆ†å‘/æ‹¦æˆªçš„è¿‡ç¨‹ï¼Œä¸»è¦è®²çš„æ˜¯ ViewGroup / View çš„å‡ ä¸ªå…³é”®æ–¹æ³•ä»¥åŠä½¿ç”¨åœºæ™¯

åœ¨æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠç¬¬ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œè§¦æ‘¸äº‹ä»¶çš„èµ·æº

## ä»ç¡¬ä»¶åˆ°å†…æ ¸

åœ¨[ã€Šå½“æˆ‘ä»¬ç‚¹å‡»â€œå¾®ä¿¡â€åº”ç”¨åï¼Œå®ƒæ˜¯æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿã€‹](https://mp.weixin.qq.com/s/JeGPyknzc0G_TCQNHZD3AQ)è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä¸ºäº†ææ¸…æ¥š Android è®¾å¤‡çš„ç»˜å›¾ç¡¬ä»¶æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬æ‹†äº†ä¸€å° å°ç±³11 æ‰‹æœº

ä»Šå¤©ï¼Œæˆ‘ä»¬ç»§ç»­æ¥æ‹†å°ç±³

![android_graphic_v5_mi10](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_mi10.png)

*å›¾ç‰‡æ¥æºï¼š[ã€é›†å¾®æ‹†è¯„ã€‘å°ç±³10æ‹†è§£ï¼šå†…éƒ¨å¸ƒå±€ä¸iPhoneç›¸ä¼¼ï¼Œ1äº¿åƒç´ ä¸»æ‘„å¸ç›](https://www.laoyaoba.com/n/748691)*

å¦‚ä¸Šå›¾ï¼Œè¿™æ˜¯æ‹†è§£å å°ç±³10 çš„å†…éƒ¨å¸ƒå±€ï¼Œå›¾ä¸­å·¦è¾¹é»„è‰²ç®­å¤´æ‰€æŒ‡çš„éƒ¨åˆ†ï¼Œæ˜¯è§¦æ‘¸å±çš„`è§¦æ§èŠ¯ç‰‡`

ç±³10 `è§¦æ§èŠ¯ç‰‡`ä½¿ç”¨çš„æ˜¯ï¼Œæ¥è‡ªæ„æ³•åŠå¯¼ä½“çš„ "`FJABH`"ï¼Œè¿™å—èŠ¯ç‰‡æ˜¯ç”¨æ¥å¹²å˜›çš„å‘¢ï¼Ÿ

ç”¨æ¥å’Œ CPU è¿›è¡Œé€šä¿¡çš„

![android_graphic_v5_ic_touch](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_ic_touch.png)

*å›¾ç‰‡æ˜¯é‡ç»˜ç‰ˆï¼Œå‚è€ƒè‡ªï¼šhttps://blog.csdn.net/qq_39797956/article/details/118863217*

æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬æŒ‰ä¸‹è§¦æ‘¸å±åï¼Œå±å¹•çš„ç”µå‹/ç”µæµå¤§å°ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆ*ä¸å±•å¼€è®¨è®ºè§¦æ‘¸å±å·¥ä½œåŸç†*ï¼‰

å˜åŒ–çš„ç”µå‹/ç”µæµä¼šè¢«å›¾ä¸­é—´çš„`è§¦æ§ IC `æ•è·ï¼Œæ¥ç€è®¡ç®—å‡ºè§¦æ‘¸ä½ç½®çš„åæ ‡å€¼ï¼Œé€šè¿‡` IÂ²C `æ€»çº¿ï¼ˆ*å¦‚ä¸Šå›¾*ï¼‰å‘é€åˆ°ä¸»æ¿ä¸Šçš„ CPU

[ IÂ²C ](https://elixir.bootlin.com/linux/v4.4.1/source/drivers/i2c)æ˜¯ç¡¬ä»¶ä¹‹é—´å¸¸ç”¨çš„ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒè§„å®šäº†ä»€ä¹ˆè¡¨ç¤ºèµ·å§‹ã€åœæ­¢ã€åº”ç­”å’Œéåº”ç­”ç­‰ä¸€ç³»åˆ—ä¿¡å·

å½“ç„¶ï¼Œä½œä¸ºåº”ç”¨å¼€å‘ï¼Œæˆ‘ä»¬æ— éœ€å…³å¿ƒä»–ä»¬çš„é€šä¿¡ç»†èŠ‚

æˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼š "**ä¸€æ—¦è§¦æ‘¸å±çš„ä¿¡å·å‘ç”Ÿå˜åŒ–ï¼Œ`è§¦æ§èŠ¯ç‰‡`å°±èƒ½é€šè¿‡ `IÂ²C` æ€»çº¿é€šçŸ¥åˆ° CPU** "ã€‚äº†è§£è¿™ä¸€ç‚¹å°±å¤Ÿäº†

å¥½äº†ï¼Œç°åœ¨è§¦æ‘¸ä¿¡å·å·²ç»èƒ½è¢« CPU è¯»å–äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ CPU ï¼Œä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿå¦‚ä½•å¤„ç†è§¦æ‘¸ä¿¡å·

## å†…æ ¸åˆ›å»ºè®¾å¤‡æ–‡ä»¶

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒGoogle ä½¿ç”¨ Linux ä½œä¸º Android ç³»ç»Ÿçš„å†…æ ¸ï¼Œç®¡ç†ç€ä¸»æ¿ä¸Šçš„ `å†…å­˜`ã€`ç½‘å¡`ã€`ç¡¬ç›˜` ç­‰ç¡¬ä»¶è®¾å¤‡ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ `CPU`

åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œè§¦æ‘¸å±å·²ç»å’Œ CPU å»ºç«‹äº†é€šä¿¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è¯»å–è§¦æ‘¸å±å‘é€è¿‡æ¥çš„ä¿¡å·äº†

æ¥ä¸‹æ¥çš„å·¥ä½œé‡ç‚¹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ**ä¸€æ˜¯åˆ¶å®šè§¦æ‘¸å±å…·ä½“çš„ä¸ŠæŠ¥è§„åˆ™ï¼›äºŒæ˜¯æƒ³åŠæ³•æŠŠè®¾å¤‡å‘ç”Ÿçš„äº‹ä»¶æŠ¥å‘Šç»™åº”ç”¨ç¨‹åº**

å…ˆæ¥çœ‹è®¾å¤‡çš„ä¸ŠæŠ¥è§„åˆ™ï¼Œæˆ‘ä»¬ä»¥é”®ç›˜äº‹ä»¶ä¸¾ä¾‹ï¼ŒåŒæ ·éƒ½æ˜¯æŒ‰ä¸‹ '`A`' æŒ‰é”®

> *`è¾¾å°”ä¼˜`* é”®ç›˜ä¸ŠæŠ¥çš„æ˜¯ï¼š`0010`
>
> *`ç½—æŠ€`* é”®ç›˜ä¸ŠæŠ¥çš„æ˜¯ï¼š`0001`

åŒä¸€ä¸ªæŒ‰é”®äº‹ä»¶ï¼Œä¸¤ä¸ªé”®ç›˜å‚å•†ä¸ŠæŠ¥çš„æŒ‰é”®å€¼å´ä¸ç›¸åŒï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚

æ‰€ä»¥ï¼Œåªæœ‰ä¸Šä¸€å°èŠ‚çš„é€šä¿¡è§„åˆ™ï¼ˆ*IÂ²C*ï¼‰è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ¶å®šä¸€ä¸ªå†…å®¹è§„åˆ™ï¼Œæ¥è§„èŒƒå„ä¸ªå‚å®¶å‘é€çš„æ•°æ®å†…å®¹

è¯´åˆ°è¾“å…¥è§„èŒƒï¼Œè¿™å°±ä¸èƒ½ä¸æ Linux çš„ Input å­ç³»ç»Ÿäº†

åœ¨ 2001 å¹´å‘å¸ƒçš„ [*[2.4.0*]](https://elixir.bootlin.com/linux/2.4.0/source/drivers/input) ç‰ˆæœ¬ï¼ŒLinux é¦–æ¬¡åŠ å…¥äº† Input å­ç³»ç»Ÿçš„ä»£ç ï¼Œä¸ºçš„å°±æ˜¯å°†è¾“å…¥è®¾å¤‡çš„å…±æ€§æŠ½è±¡å‡ºæ¥ï¼Œåˆ¶å®šç»Ÿä¸€çš„è¾“å…¥è§„åˆ™

é¦–å‘ç‰ˆæœ¬åªæ”¯æŒ `æ‰‹æŸ„`ã€`é¼ æ ‡` å’Œ `é”®ç›˜` è¿™ä¸‰ç§ç¡¬ä»¶ï¼Œåœ¨éšå 2002 å¹´å‘å¸ƒçš„ [*[2.5.25*]](https://elixir.bootlin.com/linux/v2.5.25/source/drivers/input) ç‰ˆæœ¬ä¸­ï¼ŒåŠ å…¥äº†å¯¹ `è§¦æ‘¸å±` çš„æ”¯æŒ

è¿™æ ·ä¸€æ¥ï¼Œå‚å•†åªéœ€è¦æŒ‰ç…§ Linux åˆ¶å®šçš„è§„èŒƒï¼Œæ¥ä¸ŠæŠ¥`æŒ‰é”®å€¼`ã€`å±å¹•åæ ‡`ç­‰ä¿¡æ¯å³å¯ï¼Œä¸ŠæŠ¥è§„åˆ™çš„é—®é¢˜å°±è§£å†³äº†

é™¤äº†è§„èŒƒè¾“å…¥å†…å®¹ï¼ŒInput å­ç³»ç»Ÿè¿˜ä¸ºåº”ç”¨ç¨‹åºæä¾›äº† `æ“ä½œ/è¯»å–` è¾“å…¥è®¾å¤‡çš„æ¥å£ï¼Œæ¥çœ‹æ¡†æ¶å›¾ï¼š

![android_graphic_v5_linux_input_system](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_linux_input_system.png)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„*

å¦‚å›¾ï¼ŒInput å­ç³»ç»Ÿåˆ†ä¸ºä¸‰å±‚ï¼š

- æœ€ä¸‹å±‚ï¼š**è¾“å…¥è®¾å¤‡é©±åŠ¨å±‚ï¼Œ`drivers/input/xxx`ï¼Œè¿™é‡Œå°±æ˜¯å„å¤§å‚å•†éœ€è¦éµå¾ªçš„åè®®è§„èŒƒï¼Œå‘å†…æ ¸å±‚æŠ¥å‘Šè¾“å…¥çš„å†…å®¹**

- ä¸­é—´å±‚ï¼š**è¾“å…¥æ ¸å¿ƒå±‚ï¼Œ`input.c` å±äºè¿™ä¸€å±‚ã€‚è¿™æ˜¯ Linux æ ¸å¿ƒé€»è¾‘ï¼Œç”¨æ¥ç®¡ç†è®¾å¤‡æ·»åŠ ã€å¸è½½ç­‰æ“ä½œï¼Œäº‹ä»¶æä¾›ç»™åº”ç”¨å‰çš„å‡†å¤‡å·¥ä½œ**

- æœ€ä¸Šå±‚ï¼š**è¾“å…¥äº‹ä»¶é©±åŠ¨å±‚ï¼Œåˆ°è¿™é‡Œç¡¬ä»¶é©±åŠ¨å·²ç»æŠ½è±¡ä¸ºè®¾å¤‡æ–‡ä»¶äº†ï¼Œå¯¹åº” `/dev/input/xxx` ï¼Œç¡¬ä»¶é©±åŠ¨å‘é€çš„æ•°æ®å°±ä¿å­˜åœ¨è¯¥è·¯å¾„ä¸‹çš„å„ä¸ªè®¾å¤‡æ–‡ä»¶ä¸­ï¼Œç­‰å¾…åº”ç”¨è¯»å–**

æœ€ä¸‹é¢çš„ Drivers å±‚ï¼Œæ˜¯ Linux å¹³å°å¯¹å„ç§è¾“å…¥è®¾å¤‡çš„è§„èŒƒï¼Œå„å¤§å‚å•†éƒ½éœ€è¦å»éµå¾ªè¯¥åè®®ï¼Œå¦åˆ™ Linux å†…æ ¸æ— æ³•è¯†åˆ«ï¼Œè®¾å¤‡ä¹Ÿå°±æ— æ³•æ­£å¸¸å·¥ä½œ

ç„¶åæ˜¯ä¸­é—´çš„æ ¸å¿ƒå±‚ï¼Œå®ƒæ˜¯è¾“å…¥è®¾å¤‡é©±åŠ¨çš„ç®¡ç†å±‚ï¼Œåœ¨è¾“å…¥æ¡†æ¶ä¸­èµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼š**å‘ä¸‹æä¾›é©±åŠ¨å±‚çš„æ¥å£ï¼Œå‘ä¸Šæä¾›äº‹ä»¶å¤„ç†å±‚çš„æ¥å£**

æˆ‘ä»¬æ¥çœ‹ä¸€çœ¼ input.c ä¸­çš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼Œä¹Ÿå°±å¤§æ¦‚çŸ¥é“å®ƒæä¾›äº†å“ªäº›åŠŸèƒ½

```c
/drivers/input/input.c
class input { //Linux input æ¡†æ¶çš„æ ¸å¿ƒå±‚ï¼Œä¸ºé©±åŠ¨å±‚æä¾›è®¾å¤‡æ³¨å†Œå’Œæ“ä½œæ¥å£

  	/* è®¾å¤‡æ³¨å†Œ */
    int input_register_device(input_dev *dev); // æ³¨å†Œä¸€ä¸ª input è®¾å¤‡åˆ°å†…æ ¸
    void input_unregister_device(input_dev *dev); // ä»å†…æ ¸æ³¨é”€æ‰ä¸€ä¸ª input è®¾å¤‡

  	/* è®¾å¤‡è¿æ¥ */
    int input_attach_handler(input_dev *dev, input_handler *handler);
  	void input_disconnect_device(input_dev *dev);
  
  	/* äº‹ä»¶ä¸ŠæŠ¥ */
  	void input_handle_event(input_dev *dev, type, code, value);
  
  	/* åº”ç”¨ç¨‹åºæ•°æ®è¯»å– */
  	int input_event_to_user(input_dev *dev, type, code, value);

}
```

ä»ä»£ç æ¥çœ‹ï¼Œæ ¸å¿ƒå±‚è´Ÿè´£ `è®¾å¤‡çš„æ³¨å†Œ`ã€`è®¾å¤‡çš„è¿æ¥`ã€`äº‹ä»¶ä¸ŠæŠ¥` å’Œ `æ•°æ®è¯»å–` è¿™å‡ ä»¶äº‹ï¼Œå…·ä½“çš„å®ç°é€»è¾‘æˆ‘ä»¬è¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œå¤ªé•¿äº†ã€‚

åœ¨ Input å­ç³»ç»Ÿçš„æœ€ä¸Šå±‚ï¼ˆHandlersï¼‰ï¼Œäº‹ä»¶é©±åŠ¨å±‚è´Ÿè´£çš„æ˜¯ï¼Œ**ä¸ºç”¨æˆ·è®¿é—®æä¾›æ¥å£ï¼Œå°†ç¡¬ä»¶é©±åŠ¨å±‚å‘é€çš„æ¶ˆæ¯æŠ¥å‘Šç»™ç”¨æˆ·**

æˆ‘ä»¬å¯ä»¥åœ¨ `/dev/input/xxx` æ‰¾åˆ°æ‰€æœ‰å·²åŠ è½½æˆåŠŸçš„è¾“å…¥è®¾å¤‡ï¼Œå®ƒä»¬å°±æ˜¯äº‹ä»¶é©±åŠ¨å±‚åˆ›å»ºçš„è®¾å¤‡æ–‡ä»¶

![android_graphic_v5_pixel3_devices](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_pixel3_devices.jpg)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªçš„*

å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘æ‰‹é‡Œçš„ Pixel 3 åœ¨ `/dev/input/` è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œå‘ç°äº†4ä¸ªè¾“å…¥è®¾å¤‡ï¼Œä» `event0` åˆ° `event3`

æˆ‘ä»¬å¯ä»¥ç”¨ ' `cat /proc/bus/input/devices` ' å‘½ä»¤ï¼ŒæŸ¥çœ‹æ¯ä¸ªè¾“å…¥è®¾å¤‡çš„ä¿¡æ¯ï¼Œæˆ‘è¿™å°æ‰‹æœº `event2` èŠ‚ç‚¹æ˜¯è§¦æ‘¸å±çš„è®¾å¤‡æ–‡ä»¶ï¼ˆ*' `name = fts` ' è¡¨ç¤ºçš„è§¦æ§é©±åŠ¨å‚å•†æ˜¯ '`æ•¦æ³°`'*ï¼‰

æ¥ç€ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ '`getevent`' å‘½ä»¤æ‰“å¼€è¿™ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œè·å–å®ƒå‘é€çš„åŸå§‹æ•°æ®

![android_graphic_v5_pixel3_getevent](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_pixel3_getevent.GIF)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„*

ä½ çœ‹ï¼Œå½“æˆ‘ä»¬æ»‘åŠ¨å±å¹•æ—¶ï¼Œç»ˆç«¯çª—å£ä¼šä¸åœçš„æ‰“å°æ¥è‡ª `event2` çš„è§¦æ‘¸äº‹ä»¶æ¶ˆæ¯

å¥½ï¼Œç°åœ¨è§¦æ‘¸äº‹ä»¶å·²ç»èƒ½è¢«åº”ç”¨ç¨‹åºè¯»å–äº†ï¼Œæˆ‘ä»¬æ¥ç®€å•æ€»ç»“ä¸‹ç¬¬ä¸€éƒ¨åˆ† â€˜è§¦æ‘¸äº‹ä»¶çš„èµ·æºâ€™ çš„å†…å®¹ï¼š

é¦–å…ˆï¼ŒæŒ‰ä¸‹è§¦æ‘¸å±åï¼Œ`è§¦æ§èŠ¯ç‰‡`æ•è·åˆ°ç”µå‹/ç”µæµçš„å˜åŒ–ï¼Œè®¡ç®—å‡ºä½ç½®åæ ‡åï¼Œé€šè¿‡` IÂ²C` æ€»çº¿æ±‡æŠ¥ç»™ CPU

æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿä¸€é€šä¿¡å†…å®¹çš„è§„åˆ™ï¼Œåœ¨ Linux å¹³å°ä¸‹ï¼Œè§¦æ§èŠ¯ç‰‡éœ€è¦å®ç° `input.c` åè®®ï¼Œäº‹ä»¶æŒ‰ç…§è§„å®šçš„åè®®ä¸ŠæŠ¥ç»™å†…æ ¸ç³»ç»Ÿ

æœ€åï¼Œç­‰åˆ°è®¾å¤‡å¼€æœºï¼Œå†…æ ¸åŠ è½½è§¦æ‘¸å±é©±åŠ¨ï¼Œå†ç„¶åæ˜¯è®¾å¤‡çš„`æ³¨å†Œ/è¿æ¥/ä¸ŠæŠ¥`çš„è¿‡ç¨‹

åˆ°è¿™é‡Œï¼Œå†…æ ¸å·²ç»ä¸ºæˆ‘ä»¬æ”¶é›†å¥½è§¦æ‘¸å±çš„è¾“å…¥äº‹ä»¶ï¼Œå¹¶å­˜æ”¾åœ¨äº† `eventX` è®¾å¤‡æ–‡ä»¶ä¸­ï¼ŒLinux Input å­ç³»ç»Ÿçš„ä»»åŠ¡å·²ç»å®Œæˆ

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Android ç³»ç»Ÿçš„æ¡†æ¶å±‚ï¼ˆFrameworkï¼‰æ˜¯å¦‚ä½•å¤„ç†è§¦æ‘¸äº‹ä»¶çš„

# äºŒã€è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ï¼ˆAndroid Frameworkï¼‰

ä¸Šå›ä¹¦è¯´åˆ°ï¼Œè§¦æ‘¸å±ä¸ŠæŠ¥çš„äº‹ä»¶å·²ç»ä¿å­˜åˆ° `/dev/input/xxx` è®¾å¤‡æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆç³»ç»Ÿæ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼š

è¯»å–è§¦æ‘¸äº‹ä»¶ï¼Œå¹¶å°è£…æˆ `MotionEvent` / `KeyEvent` å¯¹è±¡ï¼Œæœ€ååˆ†å‘ç»™æ­£åœ¨è¿è¡Œçš„ APP ä½¿ç”¨

â€**è¯»å–**â€œ å’Œ â€œ**åˆ†å‘**â€ ï¼Œæ˜¯ Android Framework çš„ä¸»çº¿ä»»åŠ¡

åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¸»è¦å›´ç»•ç€è¿™ä¸¤ä»¶äº‹å±•å¼€

> psï¼šæœ¬ç« èŠ‚çš„ '`äº‹ä»¶åˆ†å‘`' æ¢è®¨çš„æ˜¯ï¼Œå¦‚ä½•å°†è§¦æ‘¸äº‹ä»¶ä»è®¾å¤‡æ–‡ä»¶ä¼ é€’åˆ° APP è¿›ç¨‹ï¼Œå’Œ View çš„äº‹ä»¶åˆ†å‘ä¸æ˜¯ä¸€å›äº‹å„¿ï¼Œæ³¨æ„åˆ«ææ··äº†

## åˆè¯† InputManagerService

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Framework ä¸­ï¼Œè¾“å…¥äº‹ä»¶æ˜¯ç”± InputManagerServiceï¼ˆåç»­ç®€ç§°IMSï¼‰ æ¥ç®¡ç†

æˆ‘ä»¬åˆçŸ¥é“ï¼ŒInputManagerService æ˜¯ Java å±‚ä»£ç ï¼Œä¸å¯èƒ½ç›´æ¥è°ƒç”¨åˆ° Linux å†…æ ¸å±‚çš„ Input æ¡†æ¶æ¥è·å–è¾“å…¥äº‹ä»¶

å› æ­¤ï¼ŒIMS å¿…ç„¶éœ€è¦ native å±‚çš„æ”¯æŒï¼Œæ‰èƒ½å®ç°å¯¹äº‹ä»¶çš„è¯»å–ä¸åˆ†å‘

å®é™…çš„ InputManagerService å®ç°ä¸€å…±åˆ†ä¸ºä¸‰å±‚

1. **native å±‚ï¼Œè¿™æ˜¯ IMS çš„æ ¸å¿ƒå±‚ï¼Œè´Ÿè´£ `è¯»å–/åˆ†å‘` äº‹ä»¶ï¼Œ`EventHub.cpp`ã€`InputReader.cpp`ã€`InputDispatcher.cpp` ä¸‰å‘˜å¤§å°†éƒ½åœ¨è¿™**
2. **jni å±‚ï¼Œä¸»è¦æ˜¯å¯¹ natvie åšè½¬å‘ï¼Œå¦å¤–è´Ÿè´£åˆ›å»ºå¯¹è±¡å•¥çš„ï¼Œä¸æ€ä¹ˆéœ€è¦å…³æ³¨**
3. **Java å±‚ï¼Œä¸»è¦è´Ÿè´£é€šä¿¡éƒ¨åˆ†ï¼Œå’Œ WMS åŒæ­¥çª—å£æ•°æ®å•¦ï¼Œå’Œ APP è·¨è¿›ç¨‹é€šä¿¡å•¦ç­‰ç­‰**

åœ¨è¿™å…¶ä¸­ï¼Œåªæœ‰ native å±‚ç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹å¤æ‚ï¼Œå› ä¸ºæ•°æ®çš„è¯»å–å’Œåˆ†å‘éƒ½å‘ç”Ÿåœ¨ native å±‚

å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è®¤è¯† native å±‚çš„ä¸»åŠ›äººå‘˜

æ³¨æ„ï¼Œæˆ‘ä»¬æœ¬å°èŠ‚åªå…³æ³¨ native ä¸­å„ä¸ªè§’è‰²æœ‰å“ªäº›æ–¹æ³•åŠŸèƒ½ï¼Œåšäº†å“ªäº›äº‹æƒ…

è‡³äºå¯¹è±¡ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Œè¿è¡Œåœ¨å“ªä¸ªè¿›ç¨‹ï¼Œå“ªä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°ï¼Œä¸æ˜¯æœ¬å°èŠ‚å…³æ³¨çš„é‡ç‚¹

### 1ã€EventHub

EventHub çš„ä½œç”¨æ˜¯ç›‘å¬ã€è¯»å– `/dev/input` ç›®å½•ä¸‹äº§ç”Ÿçš„æ–°äº‹ä»¶ï¼Œå¹¶å°è£…æˆ `RawEvent` ç»“æ„ä½“ä¾›å…¶ä»–äººä½¿ç”¨

æ–‡ä»¶åœ¨ frameworks/native/services/inputflinger/EventHub.cpp

æˆ‘ä»¬æ¥çœ‹ EventHub ä¸­çš„å…³é”®æ–¹æ³•

```c++
//frameworks/native/services/inputflinger/EventHub.cpp
class EventHub {

    EventHub::EventHub(void)  {
        mEpollFd = epoll_create(EPOLL_SIZE_HINT); // åˆ›å»º epollï¼Œç”¨äºç›‘å¬è®¾å¤‡æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶
        mINotifyFd = inotify_init(); // åˆ›å»º inotify ï¼Œç”¨äºç›‘å¬æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–è¯´æ˜å‘ç”Ÿè®¾å¤‡æ’æ‹”
    }

    size_t EventHub::getEvents( timeoutMillis, buffer, bufferSize) {
        //getEvents() æ˜¯ IMS çš„æ ¸å¿ƒï¼Œè¯¥æ–¹æ³•ä¸€å…±åšäº†ä¸¤ä»¶äº‹
        // 1. ç›‘å¬è®¾å¤‡æ’æ‹”åŠ¨ä½œï¼Œæ‰§è¡Œå¯¹åº”çš„è®¾å¤‡çš„æ‰“å¼€/å¸è½½æ“ä½œï¼Œå¹¶ç”Ÿæˆ RawEvent ç»“æ„é€šçŸ¥è°ƒç”¨è€…
        // 2. ç›‘å¬è¾“å…¥è®¾å¤‡æ–‡ä»¶çš„äº‹ä»¶å˜åŒ–
        //å¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œè°ƒç”¨ epoll_wait() å‡½æ•°æ‰§è¡Œç­‰å¾…
        return event - buffer; // è¿”å›è¯»å–åˆ°çš„äº‹ä»¶æ•°é‡
    }


}
```

EventHub åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆ›å»º `mEpollFd` å’Œ `mINotifyFd` ä¸¤ä¸ª Fdï¼Œåˆ©ç”¨ `INotify` æœºåˆ¶ç›‘å¬è®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œåˆ©ç”¨ `Epoll` ç›‘å¬è®¾å¤‡æ–‡ä»¶è¯»å†™çŠ¶æ€å˜åŒ–

ç„¶åæ˜¯ `getEvents()` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥è·å–å½“å‰çš„è®¾å¤‡äº‹ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ•°é‡å˜åŒ–ï¼Œå’Œè®¾å¤‡ä¸ŠæŠ¥çš„äº‹ä»¶ï¼Œæ˜¯ IMS è·å–æ¶ˆæ¯çš„ â€œæ ¸å¿ƒæ–¹æ³•â€

å¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œ`getEvents()` ä¼šå‘ç”Ÿé˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæ‰è¿”å›

EventHub æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾

![android_graphic_v5_native_1](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_native_1.png)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„*

### 2ã€InputReader

ä»ç±»çš„å‘½åå°±èƒ½çœ‹å‡ºæ¥ï¼ŒInputReader çš„èŒè´£æ˜¯è¯»å–è¾“å…¥æ¶ˆæ¯

ä¸è¿‡ï¼Œå®ƒå¯ä¸æ˜¯åªä¼šè¯»å–äº‹ä»¶ï¼Œæ‹¿åˆ°åŸå§‹äº‹ä»¶ä»¥åï¼Œè¿˜éœ€è¦è§£æäº‹ä»¶ï¼Œæ‹†è§£ä¸º`æŒ‰é”®`ã€`è§¦æ‘¸å±`ã€`é¼ æ ‡`ç­‰ï¼Œæ ¹æ®ä¸åŒçš„è¾“å…¥ï¼Œå°è£…æˆä¸åŒçš„å¯¹è±¡ï¼Œæäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…åˆ†å‘

æ‰€ä»¥ï¼ŒåŸå§‹äº‹ä»¶çš„è§£æã€è½¬æ¢ï¼Œæœ€åç”Ÿæˆ `KeyEvent`ã€`MotionEvent` å¯¹è±¡ï¼Œæ‰æ˜¯ InputReader çš„ä¸»è¦å·¥ä½œ

```c++
/frameworks/native/services/inputflinger/InputReader.cpp
class InputReader {

    class InputReaderThread : Thread { //å†…éƒ¨ç±»

        /*InputReaderThread çº¿ç¨‹å¯åŠ¨åï¼Œå¾ªç¯å°†ä¸æ–­åœ°æ‰§è¡Œ InputReader#loopOnce()å‡½æ•°*/
        bool InputReaderThread::threadLoop() {
            mReader->loopOnce();
            return true;
        }
    }

    void InputReader::loopOnce(); // æ ¸å¿ƒæ–¹æ³•ï¼Œè´Ÿè´£è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶
}
```

InputReader ç±»çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ `InputReader#loopOnce()` ï¼Œå®ƒè´Ÿè´£è¯»å–äº‹ä»¶å’Œè§£æäº‹ä»¶

`loopOnce()` æ–¹æ³•è¢« InputReaderThread çº¿ç¨‹çš„ `threadLoop()` æ‰€è°ƒç”¨ï¼ŒInputReaderThread æ˜¯ InputReader çš„å†…éƒ¨çº¿ç¨‹ç±»

å’Œ Java ä¸åŒï¼Œåœ¨ C++ ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† `threadLoop()` è¿”å›å€¼è®¾ç½®ä¸º trueï¼Œå½“ InputReaderThread çº¿ç¨‹å¯åŠ¨åï¼Œ è¯¥æ–¹æ³•å°±ä¼šè¢«å¾ªç¯è°ƒç”¨ï¼Œä¸ç”¨æ‰‹åŠ¨å†™ `while(true)`

InputReaderThread çº¿ç¨‹å¯åŠ¨æ—¶æœºæˆ‘ä»¬åé¢ä¼šè®²åˆ°ï¼Œå…ˆå›è¿‡å¤´æ¥çœ‹ `InputReader#loopOnce()` çš„å·¥ä½œ

```c++
/frameworks/native/services/inputflinger/InputReader.cpp
class InputReader {
  
    // è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶
    void InputReader::loopOnce() {
        int count = mEventHub->getEvents(); // è¯»æ¶ˆæ¯ï¼Œæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ²¡æ¶ˆæ¯é˜»å¡åˆ° epoll()ã€‚ç”±äºäº‹ä»¶åˆ†å‘éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥å•æ¬¡è¯»å–çš„äº‹ä»¶å¯èƒ½æ˜¯å¤šä¸ª
        if(count) processEventsLocked();//è§£æåŸå§‹äº‹ä»¶ã€æäº¤åˆ°é˜Ÿåˆ—ç­‰å¾…åˆ†å‘
    }
}
```

å…³é”®ä»£ç åªæœ‰ä¸¤è¡Œ

ç¬¬ä¸€è¡Œæ˜¯è°ƒç”¨äº† `EventHub#getEvents()` è·å–äº‹ä»¶ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»ä»‹ç»è¿‡è¿™ä¸ªæ–¹æ³•äº†ï¼Œæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ²¡æ¶ˆæ¯é˜»å¡åˆ° `epoll()`

å¹¶ä¸”ï¼Œå› ä¸ºæ‰§è¡Œäº‹ä»¶åˆ†å‘éœ€è¦æ—¶é—´ï¼Œåœ¨ä¸Šä¸€æ¬¡åˆ†å‘è¿˜æ²¡æœ‰æ‰§è¡Œç»“æŸä¹‹å‰ï¼Œå¦‚æœå¤šä¸ªè®¾å¤‡éƒ½å‘ç”Ÿäº†äº‹ä»¶ï¼Œæˆ–è€…ä¸€ä¸ªè®¾å¤‡å‘é€äº†å¤šæ¬¡äº‹ä»¶ï¼Œéƒ½ä¼šé€ æˆæ•°æ®çš„ç§¯å‹ï¼Œ`getEvents()` è¿”å›çš„äº‹ä»¶æ•°é‡å¯èƒ½æ˜¯å¤šæ¡

ç¬¬äºŒè¡Œä»£ç  `processEventsLocked()` æ˜¯è·å–åˆ°äº‹ä»¶ä»¥åï¼Œå¯¹åŸå§‹äº‹ä»¶è¿›è¡Œè§£æï¼Œç„¶åæäº¤åˆ°é˜Ÿåˆ—ç­‰å¾…åˆ†å‘

```c++
/frameworks/native/services/inputflinger/InputReader.cpp
class InputReader {

    void InputReader::processEventsLocked(rawEvents, count) {
        // éå†æ‰€æœ‰äº‹ä»¶ï¼Œè§£æã€åˆ†å‘
        for (const RawEvent* rawEvent = rawEvents; count;) {
            int32_t type = rawEvent->type; // è·å–äº‹ä»¶ç±»å‹
            switch (type){ // æºç ä¸åŒ…å«æ­¤ switch é€»è¾‘ï¼Œè¿™æ˜¯ InputDevice ä¸­çš„å†…å®¹ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£æˆ‘æ‰æ¬äº†è¿‡æ¥
                case EV_KEY; // æŒ‰é”®ç±»å‹çš„äº‹ä»¶ã€‚èƒ½å¤Ÿä¸ŠæŠ¥è¿™ç±»äº‹ä»¶çš„è®¾å¤‡æœ‰é”®ç›˜ã€é¼ æ ‡ã€æ‰‹æŸ„ã€æ‰‹å†™æ¿ç­‰ä¸€åˆ‡æ‹¥æœ‰æŒ‰é’®çš„è®¾å¤‡ï¼ˆåŒ…æ‹¬æ‰‹æœºä¸Šçš„å®ä½“æŒ‰é”®ï¼‰
                case EV_ABS; // ç»å¯¹åæ ‡ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†åœ¨ç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œè§¦æ§æ¿ã€è§¦æ‘¸å±ç­‰ä½¿ç”¨ç»å¯¹åæ ‡çš„è¾“å…¥è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥è¿™ç±»äº‹ä»¶
                case EV_REL; // ç›¸å¯¹åæ ‡ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†äº‹ä»¶åœ¨ç©ºé—´ä¸­ç›¸å¯¹äºä¸Šæ¬¡äº‹ä»¶çš„åç§»é‡ã€‚é¼ æ ‡ã€è½¨è¿¹çƒç­‰åŸºäºæ¸¸æ ‡æŒ‡é’ˆçš„è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥æ­¤ç±»äº‹ä»¶
                case EV_SW; // å¼€å…³ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†è‹¥å¹²å›ºå®šçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢ã€‚æ‰‹æœºä¸Šçš„é™éŸ³æ¨¡å¼å¼€å…³æŒ‰é’®ã€æ¨¡å¼åˆ‡æ¢æ‹¨ç›˜ç­‰è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥æ­¤ç±»äº‹ä»¶
                ...
            }
            // æˆ‘ä»¬åªä¸“æ³¨ touch è§¦æ‘¸äº‹ä»¶
            dispatchTouches(when, policyFlags);
        }
    }

    void dispatchTouches(){
        // åˆ¤æ–­æ˜¯å¦åªæ˜¯å•æŒ‡äº‹ä»¶ï¼Œæˆ–æ˜¯å¤šæŒ‡è§¦æ‘¸ç­‰ç­‰ç­‰
        // è§£æå®Œæˆåï¼Œè°ƒç”¨ dispatchMotion() åˆ†å‘
        dispatchMotion();
    }

    void dispatchMotion(){
        // æœ€ç»ˆç”Ÿæˆ NotifyMotionArgs ç»“æ„ï¼Œäº¤ç»™ InputDispatcher æ‰§è¡Œæœ€åçš„åˆ†å‘
        NotifyMotionArgs args;
        InputDispatcher::notifyMotion(args);//æäº¤åˆ° InputDispatcher
    }

}
```

> psï¼šä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘æŠŠå…¶ä»–åˆ†æ”¯æ•´åˆåˆ°ä¸»æ–¹æ³•æ¥ï¼Œä¸­é—´è¿˜çœç•¥äº†è®¸å¤šä»£ç ã€‚æ‰€ä»¥å»ºè®®ä¸è¦å¯¹ç…§æºç çœ‹è¿™ç¯‡æ–‡ç« ï¼Œä¸ç„¶ä½ å¯èƒ½ä¼šå› ä¸ºæ‰¾ä¸åˆ°æŸä¸ªæ–¹æ³•å›æ¥éª‚æˆ‘çš„~

è§£æäº‹ä»¶çš„ä¸šåŠ¡é€»è¾‘å‡ ä¹éƒ½æ”¾åœ¨äº† `processEventsLocked()` æ–¹æ³•

åœ¨ `processEventsLocked()` æ–¹æ³•ä¸­ï¼Œé¦–å…ˆéå†äº‹ä»¶é›†åˆï¼Œæ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„è§£ææ–¹æ³•

æˆ‘ä»¬åªä¸“æ³¨ touch è§¦æ‘¸äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ `dispatchTouches()`

åœ¨ `dispatchTouches()` æ–¹æ³•ä¸­ï¼Œæ ¹æ®è§¦æ‘¸ç‚¹ä¿¡æ¯æ¥å†³å®šï¼Œæ˜¯å•æŒ‡è¿˜æ˜¯å¤šæŒ‡äº‹ä»¶

è§£æå®Œæˆåï¼Œè°ƒç”¨ `dispatchMotion()` ç”Ÿæˆ `NotifyMotionArgs` å¯¹è±¡ï¼Œé€šçŸ¥ `InputDispatcher#notifyMotion()` æ–¹æ³•

å½“ `InputDispatcher#notifyMotion()` æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¹Ÿå°±ä»£è¡¨ç€ï¼Œä¸€æ¬¡è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶çš„è¿‡ç¨‹å°±ç»“æŸäº†

æ¥ä¸‹æ¥å°±çœ‹äº‹ä»¶æ˜¯æ€ä¹ˆåˆ†å‘çš„äº†ï¼ŒInputReader æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾

![android_graphic_v5_native_2](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_native_2.png)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„*

### 3ã€InputDispatcher

æ¥ä¸‹æ¥çš„ InputDispatcher åº”è¯¥ä¸ç”¨å†ä»‹ç»äº†ï¼Œå°±æ˜¯ç”¨æ¥åˆ†å‘è¾“å…¥äº‹ä»¶çš„

ä¸Šä¸€å°èŠ‚ç»“æŸæ—¶æ”¾çš„å›¾ç‰‡ï¼Œå·¦è¾¹çš„ InputReader å‘ä¸­é—´çš„ EventQueue é˜Ÿåˆ—æäº¤äº†äº‹ä»¶æ¶ˆæ¯ï¼Œæˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹è¿™æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„

```c++
/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void notifyMotion(const NotifyMotionArgs* args) {
        MotionEntry* newEntry = new MotionEntry(args);//å°è£…æˆentry
        enqueueInboundEventLocked(newEntry);//å…¥åˆ—ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç­‰å¾…åˆ†å‘è¢«æ‰§è¡Œï¼Œé€»è¾‘åœ¨ dispatchOnce()
    }

}
```

å‘ï¼Œçœ‹ä»£ç 

ä¸Šä¸€å°èŠ‚æœ€åä¸€è¡Œè°ƒç”¨çš„ `InputDispatcher#notifyMotion()` æ–¹æ³•ï¼Œä½œç”¨å°±æ˜¯æŠŠäº‹ä»¶æ¶ˆæ¯æäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ†å‘

å¥½ï¼Œå°¾æ”¶å®Œäº†æˆ‘ä»¬ç»§ç»­æ¥çœ‹ InputDispatcher ç±»

åˆ°äº† InputDispatcher è¿™é‡Œï¼ŒåŸå§‹çš„è¾“å…¥äº‹ä»¶å·²ç»è¢«å°è£…æˆ `Key` ã€`Motion` ç­‰å¯¹è±¡ï¼ŒInputDispatcher çš„ä»»åŠ¡æ˜¯ï¼šæ‰¾åˆ°åˆé€‚çš„ Windowï¼Œå¹¶æŠŠæ•°æ®ä¼ é€’è¿‡å»

```c++
/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    class InputDispatcherThread : Thread {

        bool InputDispatcherThread::threadLoop() {
            mDispatcher->dispatchOnce();
            return true;
        }
    }

    void dispatchOnce() {
        if(!queue.isEmpty()) dispatchOnceInnerLocked();//æœ‰æ¶ˆæ¯å°±æ‰§è¡Œåˆ†å‘
    }

}
```

é¦–å…ˆæ¥çœ‹ InputDispatcher çš„ `dispatchOnce()` ä¸»æ–¹æ³•ï¼Œå’Œ InputReader è®¾è®¡æ€è·¯ç›¸åŒï¼ŒInputDispatcher ä¹Ÿæ˜¯å†…éƒ¨æœ‰ä¸ªçº¿ç¨‹ç±»ï¼Œç„¶åå¾ªç¯è°ƒç”¨ `dispatchOnce()` æ‰§è¡Œåˆ†å‘

å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯ï¼Œè°ƒç”¨ `dispatchOnceInnerLocked()` æ‰§è¡Œåˆ†å‘

```c++
/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void dispatchOnceInnerLocked() {
        mPendingEvent = queue.dequeue(); // ä»æ´¾å‘é˜Ÿåˆ—å–å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œç®€ç•¥å†™æ³•
        switch (mPendingEvent->type) { // åˆ¤æ–­æ¶ˆæ¯çš„ç±»å‹ï¼šé…ç½®æ›´æ”¹ã€æ’æ‹”æ¶ˆæ¯ã€keyäº‹ä»¶ã€è§¦æ‘¸äº‹ä»¶ç­‰ç­‰
            case EventEntry::TYPE_MOTION:
                dispatchMotionLocked(); // æˆ‘ä»¬åªä¸“æ³¨ è§¦æ‘¸äº‹ä»¶
        }
    }

    void dispatchMotionLocked() {
        int32_t injectionResult = findTouchedWindowTargetsLocked(); // ä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£
        if (injectionResult) dispatchEventLocked(); // å¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œåˆ™é€šè¿‡dispatchEventLocked()å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ
    }

}
```

è´Ÿè´£åˆ†å‘çš„ `dispatchOnceInnerLocked()` æ–¹æ³•éœ€è¦å¤„ç†ä¸åŒè¾“å…¥ç±»å‹çš„äº‹ä»¶ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯åªå…³æ³¨è§¦æ‘¸æ¶ˆæ¯

å¦‚æœæ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œé‚£ä¹ˆè§¦æ‘¸æ¶ˆæ¯çš„åˆ†å‘æ˜¯ç”± `dispatchMotionLocked()` æ–¹æ³•æ¥å®Œæˆçš„

`dispatchMotionLocked()` è§¦æ‘¸æ¶ˆæ¯çš„åˆ†å‘ï¼Œåˆ†ä¸ºä¸¤æ­¥æ‰§è¡Œï¼š

**ç¬¬ä¸€æ­¥ï¼Œä¸º `Motion` äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£ï¼Œè¿™ä¸ªä»»åŠ¡äº¤ç»™ `findTouchedWindowTargetsLocked()` å‡½æ•°å»å®Œæˆ**

**ç¬¬äºŒæ­¥ï¼Œå¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œäº¤ç»™ `dispatchEventLocked()` å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ**

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ï¼Œ`findTouchedWindowTargetsLocked()` å’Œ `dispatchEventLocked()` è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°

```c++
/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    int findTouchedWindowTargetsLocked(){
        size_t numWindows = mWindowHandles.size(); // è·å–çª—å£é›†åˆ
        for (size_t i = 0; i < numWindows; i++);//ä»å‰å‘åéå†æ‰€æœ‰çš„windowä»¥æ‰¾å‡ºè§¦æ‘¸çš„windowï¼Œå°†æ»¡è¶³æ¡ä»¶çš„æ”¾å…¥inputTargetsï¼Œæ²¡æ‰¾åˆ°è¿”å›ç¬¬ä¸€ä¸ªå‰å°window
    }
  
  	// åˆé€‚çš„ç›®æ ‡çª—å£è¢«ç¡®å®šä¸‹æ¥ä¹‹åï¼Œä¾¿å¯ä»¥å¼€å§‹å°†å®é™…çš„äº‹ä»¶å‘é€ç»™çª—å£äº†
    void dispatchEventLocked(Vector<InputTarget>& inputTargets) {
        InputChannel channel = inputTarget.inputChannel;//åˆ å‡è¿‡çš„æµç¨‹
        channel->sendMessage(&msg);//ç»™èƒ½å¤Ÿè¢«è§¦æ‘¸çš„windowå‘é€è·¨è¿›ç¨‹æ¶ˆæ¯
    }

}
```

 `findTouchedWindowTargetsLocked()` æ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼Œæ˜¯æ ¹æ®çª—å£çš„ç‚¹å‡»åŒºåŸŸä¸äº‹ä»¶å‘ç”Ÿçš„åæ ‡ç‚¹é€‰å–åˆé€‚çš„ç›®æ ‡çª—å£

ä»£ç ç¨å¾®æœ‰ç‚¹é•¿ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®¨è®ºäº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é˜…è¯»[ã€ŠWindow Touchable Regionã€‹](https://xianzhu21.space/developer/window_touchable_region/)è¿™ç¯‡æ–‡ç« 

å†æ¥çœ‹è´Ÿè´£åˆ†å‘çš„ `dispatchEventLocked()` æ–¹æ³•ï¼Œä»£ç å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œæ ¹æ®çª—å£æŸ¥æ‰¾è¯¥çª—å£å¯¹åº”çš„ `channel` ï¼Œç„¶åé€šè¿‡ `channel` è·¨è¿›ç¨‹æŠŠäº‹ä»¶ä¼ é€’åˆ° APP

åˆ°è¿™é‡Œï¼ŒInputDispatcher æ‰€æœ‰çš„åˆ†å‘å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾

![android_graphic_v5_native_3](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_native_3.png)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„*

å“ï¼Œ è¿˜æ²¡å®Œï¼Œå›å¤´æ¥çœ‹è´Ÿè´£åˆ†å‘è§¦æ‘¸æ¶ˆæ¯çš„ `InputDispatcher#dispatchMotionLocked()` å‡½æ•°

```c++
/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void dispatchMotionLocked() {
        int32_t injectionResult = findTouchedWindowTargetsLocked(); // ä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£
        if (injectionResult) dispatchEventLocked(); // å¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œåˆ™é€šè¿‡dispatchEventLocked()å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ
    }
  
    int findTouchedWindowTargetsLocked(){
        size_t numWindows = mWindowHandles.size(); // è·å–çª—å£é›†åˆ
        for (size_t i = 0; i < numWindows; i++)
        ...
    }

    void dispatchEventLocked(Vector<InputTarget>& inputTargets) {
        InputChannel channel = inputTarget.inputChannel;
        channel->sendMessage(&msg);//ç»™èƒ½å¤Ÿè¢«è§¦æ‘¸çš„windowå‘é€è·¨è¿›ç¨‹æ¶ˆæ¯
    }

}
```

å†çœ‹ä¸€éæºç ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸¤ä¸ªé—®é¢˜ ğŸ¤”

1. **è´Ÿè´£æŸ¥æ‰¾çª—å£çš„ `findTouchedWindowTargetsLocked()` æ–¹æ³•ä¸­ï¼Œ`mWindowHandles` æ‰€æŒæœ‰çš„çª—å£é›†åˆï¼Œæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ**

2. **è´Ÿè´£é€šä¿¡çš„ `dispatchEventLocked()` æ–¹æ³•ä¸­ï¼ŒInputChannel æ˜¯ä»€ä¹ˆï¼ŸIMS æ˜¯ä»€ä¹ˆæ—¶å€™å’Œ APP å»ºç«‹é€šä¿¡çš„ï¼Ÿ**

å›æƒ³ä¸€ä¸‹ï¼Œåœ¨ InputDispatcher ä¹‹å‰ï¼Œä¸ç®¡æ˜¯ EventHub ï¼Œè¿˜æ˜¯ InputReader ï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½æ˜¯åœ¨å’Œ Linux å†…æ ¸æ‰“äº¤é“ï¼Œè¯»å–äº‹ä»¶ã€è§£æäº‹ä»¶å•¥çš„

ä½†åˆ°äº† InputDispatcher è¿™é‡Œï¼Œçªç„¶å’Œåº”ç”¨ç¨‹åºäº§ç”Ÿäº†è”ç³»

**`findTouchedWindowTargetsLocked()` çš„çª—å£é›†åˆä»å“ªé‡Œæ¥çš„ï¼Ÿ**

 **`dispatchEventLocked()` åˆæ˜¯å¦‚ä½•æŠŠè§¦æ‘¸äº‹ä»¶é€šçŸ¥åˆ° APP è¿›ç¨‹çš„ï¼Ÿ**

å¸¦ç€è¿™ä¸¤ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥ InputManagerService çš„å¯åŠ¨æµç¨‹ç¯èŠ‚ï¼Œè¿™é‡Œé¢ä¸€å®šæœ‰æˆ‘ä»¬è¦å¯»æ‰¾çš„ç­”æ¡ˆ

## å¯åŠ¨ InputManagerService 

æˆ‘ä»¬çŸ¥é“ï¼ŒInputManagerService ä½œä¸ºè¿è¡Œåœ¨ SystemServer è¿›ç¨‹ä¸­çš„æœåŠ¡ï¼Œå¯åŠ¨é¡ºåºæ˜¯æ’åœ¨ Zygote è¿›ç¨‹ä¹‹åçš„

Java è™šæ‹Ÿæœºåˆå§‹åŒ–å®Œæˆåï¼Œå†ç”± Zygote è¿›ç¨‹ fork è€Œæ¥

æœ¬å°èŠ‚æˆ‘ä»¬å°†è¦æ¥è·Ÿè¸ª InputManagerService çš„å¯åŠ¨æµç¨‹ï¼Œä¸­é—´ä¼šæ¶‰åŠåˆ°ä¸€äº›æ²¡é‚£ä¹ˆé‡è¦çš„ç±»ï¼ˆ*é‡è¦çš„éƒ½åœ¨ä¸Šé¢ä»‹ç»è¿‡äº†*ï¼‰

æ¯”å¦‚ï¼ŒåŒä¸ºåœ¨ `/frameworks/native/services/inputflinger` åŒ…ä¸‹é¢çš„ InputManager ç±»ï¼Œæˆ‘ä»¬åœ¨ä»‹ç» native å±‚æˆå‘˜çš„æ—¶å€™å°±æ²¡æœ‰å¸¦ä¸Šå®ƒ

å› ä¸º InputManager åªæ˜¯è´Ÿè´£ç®¡ç† `reader` å’Œ `dispatcher` çº¿ç¨‹ ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯å¾ˆé‡è¦

åœ¨æ•´ä¸ª IMS çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æ—¶åˆ»è¦è°¨è®°ï¼Œæœ¬èŠ‚çš„é‡ç‚¹æ˜¯ï¼š

- **äº†è§£ InputManagerService å¤§è‡´çš„å¯åŠ¨æµç¨‹**
- **äº†è§£ InputDispatcher çš„çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Œä»¥åŠ IMS å¦‚ä½•å»ºç«‹è·Ÿ APP é€šä¿¡çš„ï¼Ÿ**

ææ¸…æ¥šè¿™ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼Œ IMS å¯åŠ¨æµç¨‹è¿™ part å°±å¯ä»¥ç¿»ç¯‡äº†ï¼Œåƒä¸‡åˆ«è¢«é™·å…¥åˆ°æºç ä¸­ï¼Œå¾ˆéš¾å‡ºæ¥çš„~

### 1ã€IMS çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Ÿ

åœ¨å‰ä¸¤èŠ‚æˆ‘ä»¬äº†è§£åˆ°ï¼ŒInputManagerService å¯ä»¥åˆ†ä¸º nativeã€jniã€Java ä¸‰å±‚

è¿™ä¸‰å±‚å¤§è‡´çš„å¯åŠ¨é¡ºåºæ˜¯ï¼š**å…ˆä» Java å±‚çš„åˆå§‹åŒ–å¼€å§‹ï¼Œå†è°ƒç”¨åˆ° jni å±‚ï¼Œç”± jni æ‹‰èµ· native çš„å„ä¸ªç±»ï¼Œè¿›è€Œå®Œæˆ native éƒ¨åˆ†çš„åˆå§‹åŒ–ï¼Œæœ€åè¿”å›åˆ° Java å±‚ï¼ŒIMS å¼€å§‹ä¸ºå„ä¸ª APP æä¾›æœåŠ¡**

æˆ‘ä»¬å…ˆæ¥çœ‹ Java å±‚çš„åˆå§‹åŒ–å·¥ä½œ

```java
/frameworks/base/services/java/com/android/server/SystemServer.java
class SystemServer {

    private void startOtherServices() {
        inputManager = new InputManagerService(context); // åˆ›å»º IMS å¯¹è±¡
        ...
        //å°† InputMonitor å¯¹è±¡ä¿å­˜åˆ° IMS å¯¹è±¡
        inputManager.setWindowManagerCallbacks(wm.getInputMonitor());
        inputManager.start();
    }
}
```

åœ¨ `SystemServer#startOtherServices()` å¯åŠ¨æœåŠ¡çš„æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº† InputManagerService å¯¹è±¡

ç„¶åï¼Œå°† WindowManagerService ä¸­çš„ InputMonitor å¯¹è±¡ä¿å­˜åˆ° IMS ä¸­

**è¿™æ˜¯ InputMonitor ç±»æ˜¯å¹²å˜›çš„ï¼Ÿä¹‹å‰å¥½åƒæ²¡è§è¿‡**

ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯è¿æ¥ WMS å’Œ IMS çš„æ¢çº½ã€‚WMS é€šè¿‡ `InputMonitor.java` æŒæœ‰äº† IMS çš„å¼•ç”¨ï¼Œå½“çª—å£ä¿¡æ¯å‘ç”Ÿå˜åŒ–åï¼Œé€šè¿‡ `InputMonitor#updateInputWindowsLw()` æ–¹æ³•ï¼Œå°†æ–°çš„çª—å£é›†åˆæ›´æ–°åˆ° IMS ä¸­ï¼ŒIMS åˆå°†çª—å£é›†åˆåŒæ­¥åˆ° InputDispatcher

æˆ‘ä»¬æœ¬å°èŠ‚çš„ç›®æ ‡ä¹‹ä¸€ï¼Œæ˜¯ä¸ºäº†ææ¸…æ¥š InputDispatcher æŒæœ‰çš„çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Ÿ

**ç°åœ¨ï¼Œç­”æ¡ˆæœ‰äº†ï¼Œæ˜¯ WMS é€šè¿‡è°ƒç”¨ `InputMonitor#updateInputWindowsLw()` å‡½æ•°ï¼Œæœ€ç»ˆåŒæ­¥åˆ° InputDispatcher ç±»ä¸­**

ç®€å•è¯´ä¸€ä¸‹æŸ¥æ‰¾è¿‡ç¨‹

å…ˆå›åˆ° InputDispatcher æºç ï¼Œæœç´¢ `mWindowHandles` å…³é”®å­—ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å‘ç°äº† `mWindowHandles` é›†åˆæ˜¯åœ¨ `setInputWindows()` å‡½æ•°ä¸­è¢«èµ‹å€¼

```c++
/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void InputDispatcher::setInputWindows(inputWindowHandles) {
        mWindowHandles = inputWindowHandles;
    }
}
```

é‚£ä¹ˆ `setInputWindows()` æ˜¯è°è°ƒç”¨çš„ï¼Ÿæ¥ç€æœç´¢ Framework ï¼Œç»“æœå¦‚å›¾

![android_graphic_v5_method_setInputWindows](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_method_setInputWindows.jpg)

*å›¾ç‰‡æ¥æºï¼š[aospxref.com/android-7.1.2](http://www.aospxref.com/android-7.1.2_r39/search?page-nav=android-7.1.2_r39&full=setInputWindows&project=frameworks)*

æˆ‘ä»¬å‘ç°ï¼ŒJava å±‚çš„ IMS ä¹Ÿæœ‰ä¸€ä¸ª `setInputWindows()` æ–¹æ³•ï¼Œå¹¶é€šè¿‡ JNI æŒ‡å‘äº† native ä¸­çš„ `InputDispatcher#setInputWindows()`

**æœ€ç»ˆçš„è°ƒç”¨åŠ¨ä½œå°±å‘ç”Ÿåœ¨ InputMonitor ç±»çš„ `updateInputWindowsLw()` æ–¹æ³•ä¸­ï¼**

å¥½äº†ï¼ŒInputDispatcher æŒæœ‰çš„çª—å£é›†åˆæ¥æºï¼Œè¿™ä¸ªç–‘é—®å·²ç»è§£å†³äº†ã€‚æˆ‘ä»¬ç»§ç»­æ¥è·Ÿå¯åŠ¨æµç¨‹

```java
/frameworks/base/services/java/com/android/server/SystemServer.java
class SystemServer {
  
    private void startOtherServices() {
        inputManager = new InputManagerService(context);
        inputManager.start();
    }
}

/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java
class InputManagerService {
    // ã€step 1.0ã€‘åˆå§‹åŒ–æµç¨‹
    public InputManagerService(Context context) {
       mPtr = nativeInit(this, mContext, mHandler.getLooper().getQueue());
       LocalServices.addService(InputManagerInternal.class, new LocalService());
    }

    // ã€step 2.0ã€‘ å¯åŠ¨æµç¨‹
    public void start() {
        nativeStart(mPtr); // è¯¦è§ ã€2.1ã€‘
        Watchdog.getInstance().addMonitor(this);
    }
}
```

åœ¨ SystemServer åˆ›å»ºå®Œ InputManagerService å¯¹è±¡åï¼Œç´§æ¥ç€å°±è°ƒç”¨äº† `inputManager#start()` å¯åŠ¨äº†æœåŠ¡

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠå¯åŠ¨æµç¨‹åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤æ¥çœ‹ï¼Œ**ä¸€ä¸ªæ˜¯åˆå§‹åŒ–æµç¨‹åšäº†ä»€ä¹ˆï¼Œç¬¬äºŒä¸ªæ‰æ˜¯å¯åŠ¨æµç¨‹**

åœ¨ InputManagerService çš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† `nativeInit()` æ‰§è¡Œäº†åˆå§‹åŒ–å·¥ä½œï¼Œè¿™æ˜¯ä¸ª jni æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€èµ·å»çœ‹çœ‹æºç å®ç°

### 2ã€IMS çš„åˆå§‹åŒ–å·¥ä½œ

```c++
/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp
class NativeInputManager {

    static jlong nativeInit(env, jclass, serviceObj, contextObj, messageQueueObj) {
        NativeInputManager* im = new NativeInputManager(contextObj, serviceObj,messageQueue->getLooper()); 
    }

    NativeInputManager::NativeInputManager(contextObj, serviceObj, looper)  {
        sp<EventHub> eventHub = new EventHub(); // åˆ›å»º EventHub å¯¹è±¡
        mInputManager = new InputManager(eventHub, this, this); // åˆ›å»º InputManager å¯¹è±¡
    }

}
```

`nativeInit()` æ–¹æ³•ä¸­åˆ›å»ºäº† NativeInputManager å¯¹è±¡

åœ¨ NativeInputManager çš„æ„é€ å‡½æ•°ä¸­ï¼Œåˆåˆ›å»ºäº†ä¸¤ä¸ªæˆ‘ä»¬ç†Ÿæ‚‰çš„å¯¹è±¡ï¼Œ`EventHub` å’Œ `InputManager`

EventHub åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œè´Ÿè´£ç›‘å¬äº‹ä»¶å˜åŒ–ï¼Œå¹¶å¯¹å¤–æä¾›è·å–äº‹ä»¶å˜åŒ–çš„æ¥å£

InputManager ä¹Ÿæåˆ°è¿‡ï¼Œè´Ÿè´£åˆ›å»º Reader å’Œ Dispatcher ä¸¤çº¿ç¨‹ï¼Œæ²¡ä»€ä¹ˆé€»è¾‘

```c++
/frameworks/native/services/inputflinger/EventHub.cpp
class EventHub {

    EventHub::EventHub(void)  {
        mEpollFd = epoll_create(EPOLL_SIZE_HINT); // åˆ›å»º epollï¼Œç”¨äºç›‘å¬è®¾å¤‡æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶
        mINotifyFd = inotify_init(); // åˆ›å»º inotify ï¼Œç”¨äºç›‘å¬æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–è¯´æ˜å‘ç”Ÿè®¾å¤‡æ’æ‹”
    }
}

/frameworks/native/services/inputflinger/InputManager.cpp
class InputManager {
  
    InputManager::InputManager(eventHub, readerPolicy, dispatcherPolicy) {
        mDispatcher = new InputDispatcher(dispatcherPolicy);
        mReader = new InputReader(eventHub, readerPolicy, mDispatcher);
        initialize(); 
    }

    void InputManager::initialize() {
        mReaderThread = new InputReaderThread(mReader); //åˆ›å»ºçº¿ç¨‹ â€œInputReaderâ€
        mDispatcherThread = new InputDispatcherThread(mDispatcher); //åˆ›å»ºçº¿ç¨‹ â€InputDispatcherâ€œ
    }

}
```

å‘ï¼Œä½ çœ‹

EventHub åªæ˜¯åˆ›å»ºäº† `mEpollFd` å’Œ `mINotifyFd` ä¸¤ä¸ª Fd å¯¹è±¡

InputManager ä¹Ÿåªæ˜¯åˆ›å»ºäº† `InputReader` å’Œ `InputDispatcher` ä¸¤ä¸ªå¯¹è±¡ï¼Œç„¶ååˆ›å»ºäº† `InputReaderThread` å’Œ `InputDispatcherThread` ä¸¤ä¸ªçº¿ç¨‹

**å¥½äº†ï¼Œç°åœ¨ IMS åº•å±‚çš„ä¸‰å‘˜å¤§å°†ï¼š`EventHub`ã€`InputReader`ã€`InputDispatcher` å…¨éƒ¨æˆåŠŸåˆ›å»ºï¼ŒIMS ç±»çš„åˆå§‹åŒ–å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†**

### 3ã€IMS çš„å¯åŠ¨æµç¨‹

æˆ‘ä»¬æŠŠ SystemServer çš„ä»£ç å†æ‹¿å‡ºæ¥çœ‹çœ‹ï¼Œçœ‹çœ‹æ¥ä¸‹æ¥åº”è¯¥åšä»€ä¹ˆ

```java
/frameworks/base/services/java/com/android/server/SystemServer.java
class SystemServer {
  
    private void startOtherServices() {
        inputManager.start();
    }
}

/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java
class InputManagerService {
  
    public InputManagerService(Context context); // åˆå§‹åŒ–å·¥ä½œå·²å®Œæˆ 

    public void start() {
        nativeStart(mPtr); // å¯åŠ¨æœåŠ¡
        Watchdog.getInstance().addMonitor(this);
    }
}
```

åˆå§‹åŒ–å·¥ä½œå®Œæˆä»¥åï¼Œç´§æ¥ç€è°ƒç”¨äº† `start()` æ–¹æ³•å¯åŠ¨äº†æœåŠ¡

`start()` å†…éƒ¨è°ƒç”¨äº† `nativeStart()` æ–¹æ³•ï¼Œè¿™åˆæ˜¯ä¸ª jni å‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹è·Ÿ

```c++
/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp
class NativeInputManager {
  
    static void nativeStart(env, jclass , ptr) {
      	getInputManager()->start(); // è°ƒç”¨ InputManager çš„ start() æ–¹æ³•
    }
}

/frameworks/native/services/inputflinger/InputManager.cpp
class InputManager {
   
    status_t InputManager::start() {
        result = mDispatcherThread->run("InputDispatcher", PRIORITY_URGENT_DISPLAY); // å¯åŠ¨çº¿ç¨‹â€œInputReaderâ€
        result = mReaderThread->run("InputReader", PRIORITY_URGENT_DISPLAY); // å¯åŠ¨çº¿ç¨‹â€InputDispatcherâ€œ
        ...
        return OK;
    }
}
```

`nativeStart()` å†…éƒ¨è°ƒç”¨äº† `InputManager#start()` ï¼Œå¯åŠ¨äº† `InputReaderThread` å’Œ `InputDispatcher` çº¿ç¨‹

è¿™ä¿©çº¿ç¨‹æˆ‘ä»¬å·²ç»è§è¿‡äº†ï¼Œå¯åŠ¨åï¼Œ`InputReaderThread` å¾ªç¯è¯»æ¶ˆæ¯ï¼Œè¯»åˆ°æ¶ˆæ¯è§£æï¼Œç”Ÿæˆ Event å¯¹è±¡ï¼Œæäº¤åˆ°äº‹ä»¶é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ†å‘

`InputDispatcher` å¾ªç¯æ´¾å‘æ¶ˆæ¯ï¼Œä¸€ç›´ä»äº‹ä»¶é˜Ÿåˆ—ä¸­å– Event æ¶ˆæ¯ï¼Œæ´¾å‘ç»™åˆé€‚çš„çª—å£

åˆ°è¿™é‡Œï¼Œ IMS çš„å¯åŠ¨å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾

![android_graphic_v5_ims_process](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_ims_process.png)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„*

IMS å¯åŠ¨æµç¨‹ç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹é•¿ï¼Œå®Œæ•´çš„å¯åŠ¨åˆ†ææˆ‘æ”¾åœ¨äº† GitHub ï¼Œç‚¹å‡»[[è¿™é‡Œ]](https://github.com/yibaoshan/Blackboard/blob/master/Blog/src/main/java/com/android/blog/android/graphics/code/v5/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.cpp)è·³è½¬æŸ¥çœ‹

## å¯åŠ¨ APP è¿›ç¨‹

åœ¨ä¸Šä¸€å°èŠ‚ InputManagerService çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†â€œ **InputDispatcher çš„çª—å£é›†åˆä»å“ªé‡Œæ¥**â€ çš„é—®é¢˜

ç°åœ¨è¿˜å‰©ä¸‹ â€œ **APP æ˜¯å¦‚ä½•å’Œ IMS å»ºç«‹é€šä¿¡çš„** â€ è¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³

ç³»ç»ŸæœåŠ¡å…¨éƒ¨å‡†å¤‡å°±ç»ªåï¼Œæ¥ä¸‹æ¥æ˜¯ APP åº”ç”¨çš„å¯åŠ¨æµç¨‹ï¼Œåœ¨è·Ÿè¸ªå¯åŠ¨åº”ç”¨è¿›ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ° â€œ **APP æ˜¯å¦‚ä½•å’Œ IMS å»ºç«‹é€šä¿¡çš„** â€ è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆ

### 1ã€ä¸º Activity åˆ†é…çª—å£

APP çš„å¯åŠ¨è¿‡ç¨‹æˆ‘ä»¬åº”è¯¥éƒ½å¤šå°‘æœ‰ç‚¹äº†è§£ï¼Œå’Œ AMS é€šä¿¡æ€ä¹ˆåˆ›å»ºè¿›ç¨‹è¿™éƒ¨åˆ†æˆ‘ä»¬å°±è·³è¿‡äº†ï¼Œæœ¬ç¯‡é‡ç‚¹æ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œæˆ‘ä»¬ç›´æ¥å¿«è¿›åˆ°ä¸º Activity è®¾ç½®è§†å›¾ï¼Œåˆ†é…çª—å£è¿™éƒ¨åˆ†å†…å®¹

```java
/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl {

    InputChannel mInputChannel; // ä¿å­˜çš„æ˜¯ client ç«¯çš„ socket

    void setView(View view){
        mInputChannel = new InputChannel(); // åˆ›å»ºäº†ç©ºçš„ InputChannel ï¼Œä¸‹é¢ä»£ç å°†ä¼šç”ŸæˆçœŸå®çš„ InputChannel
        Session.addToDisplay(view,mInputChannel);//å‘wmsæ·»åŠ çª—å£

        if(mInputChannel!=null) mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper());
    }

}
```

æˆ‘ä»¬åœ¨ Activity è®¾ç½®çš„è§†å›¾æ–‡ä»¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° `ViewRootImpl#setView()` æ–¹æ³•

åœ¨ `setView()` æ–¹æ³•ä¸­ï¼Œä¸€å…±æœ‰ä¸‰è¡Œå…³é”®ä»£ç 

1. **åˆ›å»ºäº†å±äºè¯¥è§†å›¾çš„ InputChannel ç©ºå¯¹è±¡ï¼Œå…ˆä¸ç”¨ç®¡**
2. **å‘ WMS æ·»åŠ çª—å£ï¼Œå¹¶å°†åˆšåˆšåˆ›å»ºçš„ InputChannel å¯¹è±¡ä¸€å¹¶ä¼ é€’è¿‡å»ï¼Œé‡è¦é€»è¾‘**
3. **åˆ›å»ºäº† WindowInputEventReceiver ï¼Œå°†è¯¥è§†å›¾çš„ InputChannel ä¿å­˜èµ·æ¥ï¼Œä¹Ÿä¸ç”¨ç®¡**

åœ¨è¿™ä¸‰è¡Œä»£ç ä¸­ï¼Œç¬¬2è¡Œæ˜¯å…³é”®ä»£ç ï¼Œç¬¬1è¡Œå’Œç¬¬3è¡Œï¼Œä»¥ç°æœ‰çš„ä¿¡æ¯æ²¡åŠæ³•è§£é‡Šå®ƒä»¬å†…éƒ¨åšäº†ä»€ä¹ˆï¼Œç­‰åˆ°åé¢æœ‰æœºä¼šåœ¨ä»‹ç»

å¥½ï¼Œæˆ‘ä»¬æ¥çœ‹ç¬¬2è¡Œä»£ç å‘ç”Ÿäº†ä»€ä¹ˆ

```java
/frameworks/base/services/core/java/com/android/server/wm/Session.java
class Session {

    void addToDisplay(InputChannel inputChannel){
        WindowManagerService.addWindow(inputChannel);
    }

}

/frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
class WindowManagerService {

    int addWindow(InputChannel outInputChannel){
        WindowState win = new WindowState(); // é¦–æ¬¡æ·»åŠ è§†å›¾æ—¶åˆ›å»ºï¼Œç”¨äºæè¿°ä¸€ä¸ªwindow
        win.openInputChannel(outInputChannel); // åˆ›å»ºé€šä¿¡çš„å…³é”®ä»£ç ï¼Œæ‰“å¼€ä¸€å¯¹å·²è¿æ¥çš„ socket
    }

}
```

`Session#addToDisplay()` æ–¹æ³•åªæ˜¯åšäº†è½¬å‘ï¼Œå®é™…åˆ›å»ºçª—å£çš„å·¥ä½œè¿˜æ˜¯ç”± `WindowManagerService#addWindow()` æ¥å®Œæˆçš„

åœ¨ `addWindow()` æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº† WindowState å¯¹è±¡ï¼Œç”¨äºæè¿°è¯¥çª—å£ä¿¡æ¯

éšåè°ƒç”¨äº† WindowState å¯¹è±¡ä¸­çš„ `openInputChannel()` æ–¹æ³•ï¼Œå®ƒæ˜¯åˆ›å»ºé€šä¿¡çš„å…³é”®ä»£ç ï¼Œå†…éƒ¨æ˜¯åˆ›å»ºäº†ä¸€å¯¹å·²è¿æ¥çš„ `socket`

æˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨ `WindowState#openInputChannel()` æ–¹æ³•

```java
/frameworks/base/services/core/java/com/android/server/wm/WindowState.java
class WindowState {

    InputChannel mInputChannel;
    InputChannel mClientChannel;

    void openInputChannel(InputChannel outInputChannel) {
        InputChannel[] inputChannels = InputChannel.openInputChannelPair(); // è¿”å›ä¸€å¯¹å·²è¿æ¥çš„ socket
        // è¿™æ˜¯ä¸€å¯¹å·²è¿æ¥çš„ç®¡é“ï¼Œå°† socket ä¸¤ç«¯åˆ†åˆ«ä¿å­˜åˆ°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å³å¯è¿›è¡Œé€šä¿¡
        mInputChannel = inputChannels[0]; // ä¸‹æ ‡ä¸º0çš„ä¼ é€’ç»™ IMS æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¯é€šè¿‡è¯¥ socket å‘çª—å£å‘é€æ¶ˆæ¯
        mClientChannel = inputChannels[1]; // ä¸‹æ ‡ä¸º1çš„å›ä¼ ç»™ client ç«¯
        // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel
        mClientChannel.transferTo(outInputChannel);
        // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡
        InputManagerService.registerInputChannel(mInputChannel);
    }
}

/frameworks/native/libs/input/InputTransport.cpp
status_t InputChannel::openInputChannelPair(name,outServerChannel,outClientChannel) {
    int sockets[2] = socketpair(sockets);
    serverChannelName.append(" (server)");
    outServerChannel = new InputChannel(serverChannelName, sockets[0]);
    clientChannelName.append(" (client)");
    outClientChannel = new InputChannel(clientChannelName, sockets[1]);
    return OK;
}
```

`WindowState#openInputChannel()` ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº† `InputChannel#openInputChannelPair()` å‡½æ•°åˆ›å»ºä¸¤ä¸ª InputChannelï¼Œå…¶å†…éƒ¨è°ƒç”¨ Linux çš„ `socketpair()` å‡½æ•°

`socketpair()` æ˜¯ Linux æä¾›çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œè·Ÿ `pipe()` å‡½æ•°æ˜¯ç±»ä¼¼çš„ã€‚ä½† `pipe()` åˆ›å»ºçš„åŒ¿åç®¡é“æ˜¯åŠåŒå·¥çš„ï¼Œè€Œ `socketpair()` å¯ä»¥è®¤ä¸ºæ˜¯åˆ›å»ºä¸€ä¸ªå…¨åŒå·¥çš„ç®¡é“ï¼š

æˆ‘å‘æˆ‘æŒæœ‰çš„ `socket` ä¸­å†™æ•°æ®ï¼Œä½ åœ¨ä½ æŒæœ‰çš„ `socket` ä¸­èƒ½å¤Ÿè¯»åˆ°æ•°æ®ï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ï¼Œå³ä¸¤ç«¯éƒ½å¯ä»¥å¯¹è‡ªå·±æŒæœ‰çš„ `socket` è¿›è¡Œè¯»å†™

åœ¨è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ä¸­ï¼ŒGoogle å›¢é˜Ÿä½¿ç”¨äº† `socketpair()` åˆ›å»ºä¸€å¯¹å·²è¿æ¥çš„ `socket` ï¼Œç”¨äº IMS å’Œ APP é—´è·¨è¿›ç¨‹é€šä¿¡

å…¶ä¸­ï¼ŒIMS ä¼šæŒæœ‰åä¸º `server` çš„ä¸€ç«¯ï¼ˆ`sockets[0]`ï¼‰è¿›è¡Œè¯»å†™ï¼› APP æŒæœ‰åä¸º `client` çš„ä¸€ç«¯ï¼ˆ`sockets[1]`ï¼‰è¿›è¡Œè¯»å†™

**æä¸ªé†’ï¼Œæˆ‘ä»¬ç°åœ¨çœ‹çš„ä»£ç æ˜¯ï¼šè®¾ç½® Activity è§†å›¾æ—¶ï¼Œç»è¿‡ `binder` é€šä¿¡åï¼Œè·‘åœ¨äº† `system_server` è¿›ç¨‹ä¸­çš„ WMS æœåŠ¡é‡Œ**

å› æ­¤ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡ï¼Œæ˜¯æŠŠ `sockets[0]` çš„ `server` ç«¯ï¼Œä¼ é€’ç»™ IMS ï¼Œè®©è§¦æ‘¸äº‹ä»¶å‘ç”Ÿåï¼Œ IMS èƒ½å¤Ÿé€šçŸ¥åˆ° APP

ç„¶åï¼ŒæŠŠ `sockets[1]` çš„ `client` ç«¯é€šè¿‡ `binder` è·¨è¿›ç¨‹å›ä¼ ç»™ APP è¿›ç¨‹ä¿å­˜ï¼Œè®© APP èƒ½å¤Ÿæ¥æ”¶åˆ°æ¥è‡ª IMS çš„æ¶ˆæ¯

å¥½ï¼Œå¼€å§‹å¹²æ´»

### 2ã€sockets[1] å›ä¼ ç»™ APP

æºç é‡Œæ˜¯å…ˆå°† Client çš„å›ä¼ ç»™ APP è¿›ç¨‹ï¼Œé‚£æˆ‘ä»¬å°±æŒ‰ç…§æºç çš„é¡ºåºæ¥çœ‹ï¼Œå…ˆæŠŠå±äº APP è¿›ç¨‹çš„ `socket` / `InputChannel` å›ä¼ è¿‡å»

```java
/frameworks/base/services/core/java/com/android/server/wm/WindowState.java
class WindowState {

    void openInputChannel(InputChannel outInputChannel) {
        // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel
        mClientChannel.transferTo(outInputChannel);
        // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡
        InputManagerService.registerInputChannel(mInputChannel);
    }
}

/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl {

    InputChannel mInputChannel; // ä¿å­˜çš„æ˜¯ client ç«¯çš„ socket 

    void setView(View view){
        mInputChannel = new InputChannel(); // åˆ›å»ºäº†ç©ºçš„ InputChannel
      	try {
          	Session.addToDisplay(view,mInputChannel);
        } catch (RemoteException e) {
          	mInputChannel = null;
        }
        ...
        if(mInputChannel != null ) mInputEventReceiver = new InputEventReceiver(mInputChannel, Looper.myLooper()); 
    }

}
```

çœ‹ä»£ç ï¼Œ`Session#addToDisplay()` æ˜¯å°†æˆ‘ä»¬è®¾ç½®çš„è§†å›¾ï¼Œå’Œåˆšåˆšåˆ›å»ºçš„ç©ºçš„ `mInputChannel` ä¼ é€’åˆ° WindowManagerService

å¦‚æœ WMS æˆåŠŸæ·»åŠ äº†è§†å›¾ï¼Œæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œè¡¨ç¤ºå±äº APP ç«¯çš„ `socket` / `InputChannel` å·²ç»åˆ›å»ºæˆåŠŸå¹¶é€šè¿‡ `binder` è·¨è¿›ç¨‹ä¼ é€’å›æ¥äº†ï¼Œæ­¤æ—¶ `mInputChannel` å˜é‡å°±ä¸æ˜¯åˆšåˆšåˆ›å»ºçš„ç©ºå¯¹è±¡äº†ï¼Œé‡Œé¢å·²ç»åŒ…å«äº† APP ç«¯çš„ `socket`

ç›‘å¬è¿™ä¸ª `socket` ï¼Œæˆ‘ä»¬å¯ä»¥æ”¶åˆ°æ¥è‡ª IMS çš„æ¶ˆæ¯ï¼›å¾€è¿™ä¸ª `socket` å†™æ•°æ®ï¼ŒIMS ä¹Ÿå¯ä»¥æ”¶åˆ°æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ï¼Œç¾æ»‹æ»‹

å¦‚æœ WMS æ·»åŠ è§†å›¾å¤±è´¥äº†ï¼Œä¼šæŠ›å‡º `RemoteException` è¿œç¨‹è¿æ¥å¼‚å¸¸ï¼Œ`mInputChannel` å˜é‡å°†è¢«æ¸…ç©ºã€‚

æ€»ä¹‹ï¼Œåªè¦ `mInputChannel` å˜é‡ä¸ä¸ºç©ºï¼Œå°±è¡¨ç¤ºå±äº APP ç«¯çš„ `socket` å·²ç»ä¼ å›æ¥äº†ï¼Œ WMS å’Œ APP ä¸­é—´çš„ä¼ é€’è¿‡ç¨‹æˆ‘ä»¬å…ˆä¸ç®¡

å¥½ï¼Œç°åœ¨ APP ç«¯çš„ InputChannel å·²ç»å›ä¼ æˆåŠŸï¼Œä¸‹ä¸€æ­¥çš„ä»£ç æ˜¯åˆ›å»ºäº† `InputEventReceiver` å¯¹è±¡ï¼Œå¹¶å°† APP ç«¯çš„ InputChannel å’Œ APP ç«¯çš„ Looper ä¸€åŒä¼ é€’è¿‡å»

ä¸€èµ·æ¥çœ‹ InputEventReceiver çš„ä»£ç 

```java
/frameworks/base/core/java/android/view/InputEventReceiver.java
class InputEventReceiver {

    public InputEventReceiver(InputChannel inputChannel, Looper looper) {
        mReceiverPtr = nativeInit(new WeakReference<InputEventReceiver>(this),inputChannel, looper.getQueue());
    }

}
```

java å±‚çš„ InputEventReceiver åªæ˜¯ä¸ªç©ºå£³å­ï¼Œå®é™…çš„å®ç°åœ¨ native å±‚ï¼Œç»§ç»­å‘ä¸‹è·Ÿ

```c++
/frameworks/base/core/jni/android_view_InputEventReceiver.cpp
class NativeInputEventReceiver {

    static jlong nativeInit(env, clazz, receiverWeak, inputChannelObj,  messageQueueObj) { // ç®€ç•¥å†™æ³•
       int fd = inputChannelObj->getFd();
       messageQueueObj->getLooper()->addFd(fd, 0, events, this, NULL);
       ...
    }

}
```

ä»£ç æˆ‘åˆåˆå¹¶è¿‡ï¼Œå…³é”®ä»£ç å°±ä¸¤è¡Œ

**ç¬¬ä¸€è¡Œæ˜¯åˆ©ç”¨ `inputChannelObj` å¯¹è±¡è·å–é‡Œé¢çš„ `socketfd`** 

**ç¬¬äºŒè¡Œæ˜¯åˆ©ç”¨ `messageQueueObj` å¯¹è±¡è·å–é‡Œé¢çš„ Looper ï¼ŒæŠŠä¸Šä¸€æ­¥æ‹¿åˆ°çš„ `socketfd` ä¸¢è¿›å»ç›‘å¬**

ä»£ç è™½ç„¶ä¸å¤šï¼Œä½†ç†è§£è¿™ä¸¤è¡Œä»£ç ï¼Œéœ€è¦å¯¹ Handler æœºåˆ¶æ¯”è¾ƒç†Ÿæ‚‰ï¼ŒåŒ…æ‹¬ native å±‚

æˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹ï¼š

åœ¨[ã€ŠAndroidç»„ä»¶ç³»åˆ—ï¼šå†è°ˆHandleræœºåˆ¶ï¼ˆNativeç¯‡ï¼‰ã€‹](https://juejin.cn/post/7146239048191836190)è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼š**åœ¨ native å±‚åŒæ ·æ‹¥æœ‰ä¸€å¥— Looper æœºåˆ¶ã€‚è¿™å¥— Looper ä¸ä½†å¯ä»¥å¤„ç† native å±‚æ¶ˆæ¯ï¼Œè¿˜æ”¯æŒç›‘å¬ `è‡ªå®šä¹‰ fd`ï¼Œè¿™æ˜¯æœ¬å°èŠ‚çš„é‡ç‚¹**

Java å±‚çš„ MessageQueue åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ `nativeInit()` æ–¹æ³•ï¼ŒåŒæ­¥åˆ›å»º naive å±‚çš„ `NativeMessageQueue` å¯¹è±¡ï¼Œå¹¶å°†è¿”å›çš„ native å¼•ç”¨ä¿å­˜åˆ° `mPtr` å˜é‡ä¸­

æ³¨æ„çœ‹ï¼Œæˆ‘ä»¬ç°åœ¨è·Ÿè¸ªçš„ `NativeInputEventReceiver` æ„é€ å‡½æ•°çš„å…¥å‚ï¼Œä¼ é€’è¿‡æ¥çš„å‚æ•°ä¸€ä¸ªæ˜¯ `InputChannel` ï¼Œé‡Œé¢åŒ…å«äº†å±äº APP ç«¯çš„ `socket`ï¼Œè¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯æ¥è‡ª Java å±‚çš„ `MessageQueue` å¯¹è±¡

é‚£ä¹ˆï¼Œ`NativeInputEventReceiver#nativeInit()` æ–¹æ³•é‡Œå®Œæˆçš„äº‹æƒ…æ˜¯ï¼š**åˆ©ç”¨ Java MessageQueue çš„ `mPtr` å˜é‡æŒæœ‰çš„ `NativeMessageQueue` å¯¹è±¡ï¼Œæ‰¾åˆ° native Looper**

**ç„¶åï¼Œåˆ©ç”¨ native å±‚çš„ Looper å¯¹è±¡æ¥ç›‘å¬ä¸€åŒä¼ é€’è¿‡æ¥çš„ `InputChannel` ä¸­çš„ `socketfd` ã€‚**

è¿™ä¸€æ®µå¬èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œæš‚æ—¶æ²¡ç†è§£æŸä¸ªç‚¹é—®é¢˜ä¹Ÿä¸å¤§ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œåœ¨è®¾ç½®è§†å›¾çš„æ—¶å€™ï¼Œé¡ºä¾¿åˆ›å»ºäº†å’Œ IMS é€šä¿¡çš„é€šé“å°±è¡Œäº†

å“¦å¯¹äº†ï¼Œå› ä¸º Android çš„è§¦æ‘¸äº‹ä»¶ç”± native Looper å¤„ç†ï¼Œå’Œ Java Handler éƒ½è·‘åœ¨ ActivityThread çº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ UI çº¿ç¨‹åšè€—æ—¶æ“ä½œï¼Œä¼šå¯¼è‡´è§¦æ‘¸äº‹ä»¶æ— æ³•æ­£å¸¸æ¶ˆè´¹ï¼Œè¿™æ˜¯ Input ä¼šé€ æˆ `ANR` çš„åŸå› 

å¥½äº†ï¼ŒAPP ç«¯çš„ `socket`ï¼ˆ*`sockets[1]`*ï¼‰ å›ä¼ å·¥ä½œç®—æ˜¯ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ€ä¹ˆæŠŠ `sockets[0]` ä¼ é€’ç»™ IMS

### 3ã€sockets[0] ä¼ é€’åˆ° IMS

IMS ç«¯çš„ `socket` æœ€ç»ˆæ˜¯ç”± InputDispatcher æ¥ä¿ç®¡ï¼Œå› ä¸ºåˆ†å‘äº‹ä»¶æ—¶ï¼Œæ˜¯ InputDispatcher ç›´æ¥ä½¿ç”¨ `socket` é€šçŸ¥ APP çš„

æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ¬å°èŠ‚çš„ç›®æ ‡æ˜¯ï¼š**ææ¸…æ¥š IMS ç«¯çš„ `socket` æ˜¯å¦‚ä½•ä¼ é€’åˆ° InputDispatcher ç±»ä¸­çš„ï¼Ÿ**

IMS ä¼ é€’çš„èµ·ç‚¹ï¼Œä¾æ—§æ˜¯åœ¨ `WindowState#openInputChannel()` æ–¹æ³•ä¸­ï¼š

```java
/frameworks/base/services/core/java/com/android/server/wm/WindowState.java
class WindowState {

    void openInputChannel(InputChannel outInputChannel) {
        // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel
        mClientChannel.transferTo(outInputChannel);
        // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡
        InputManagerService.registerInputChannel(mInputChannel);
    }
}

/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java
class InputManagerService {

    void registerInputChannel(){
        nativeRegisterInputChannel(mPtr, inputChannel, inputWindowHandle, false);
    }
}
```

`InputManagerService#registerInputChannel()` åˆæ˜¯ä¸€ä¸ªç©ºå£³ï¼Œå…·ä½“å®ç°åœ¨ native ï¼Œç»§ç»­å‘ä¸‹è·Ÿ

```c++
/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp
class NativeInputManager {

    void nativeRegisterInputChannel(){
        InputManager->getDispatcher()->registerInputChannel(inputChannel, inputWindowHandle, monitor);
    }
}

/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    status_t InputDispatcher::registerInputChannel(inputChannel,inputWindowHandle,monitor){
        // å°†ä»£è¡¨çª—å£é€šä¿¡çš„ inputChannel ï¼Œä»¥åŠä»£è¡¨çª—å£ä¿¡æ¯çš„ inputWindowHandle å°è£…æˆ Connection å¯¹è±¡
        sp<Connection> connection = new Connection(inputChannel, inputWindowHandle, monitor);
        mConnectionsByFd.add(fd, connection);
        ... // çœç•¥ IMS ç›‘å¬æ¥è‡ª client çš„ä»£ç ï¼Œè¿™éƒ¨åˆ†æ˜¯å¤„ç† ANR çš„é€»è¾‘
    }
}
```

`NativeInputManager#nativeRegisterInputChannel()` éšæ‰‹åˆæ˜¯ä¸€ä¸ªè½¬å‘

åœ¨ `InputDispatcher#registerInputChannel()` æ–¹æ³•ä¸­ï¼Œç»è¿‡ä¸€ç•ªé•¿é€”è·‹æ¶‰ï¼Œæœ€ç»ˆå°† `socket` æ³¨å†Œåˆ° InputDispatcherï¼Œä¸€èµ·è¢«æ³¨å†Œè¿‡æ¥çš„è¿˜æœ‰ä»£è¡¨è¯¥çª—å£ä¿¡æ¯çš„ `inputWindowHandle`

ä»£è¡¨çª—å£é€šä¿¡çš„ `inputChannel` ï¼Œä»¥åŠä»£è¡¨çª—å£ä¿¡æ¯çš„ `inputWindowHandle` è¢«å°è£…æˆ `Connection` å¯¹è±¡ï¼Œä¿å­˜åˆ° `mConnectionsByFd` é›†åˆä¸­

è‡³æ­¤ï¼ŒIMS ç«¯çš„ `socket` ä¼ é€’å·¥ä½œç»“æŸï¼ŒAPP å’Œ IMS å¯ä»¥æ„‰å¿«çš„é€šä¿¡äº†

æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹

![android_graphic_v5_wms_process](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_wms_process.png)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„*

## è§¦æ‘¸äº‹ä»¶åˆ°è¾¾ ViewRootImpl

å¥½äº†ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£

ç°åœ¨ APP è¿›ç¨‹èµ·æ¥äº†ï¼ŒAPP å’Œ IMS ä¹ŸæˆåŠŸå»ºç«‹äº†é€šä¿¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ä¸‹å±å¹•ï¼Œçœ‹çœ‹è§¦æ‘¸äº‹ä»¶æ˜¯æ€ä¹ˆåˆ°è¾¾æˆ‘ä»¬ç†Ÿæ‚‰çš„ View çš„

```c++
/frameworks/base/core/jni/android_view_InputEventReceiver.cpp
class NativeInputEventReceiver {

    static jlong nativeInit(env, clazz, receiverWeak, inputChannelObj,  messageQueueObj) { // ç®€ç•¥å†™æ³•
       int fd = inputChannelObj->getFd();
       messageQueueObj->getLooper()->addFd(fd, 0, events, this, NULL);
       ...
    }

}
```

åœ¨ä»‹ç» APP ç«¯çš„ `socket` å›ä¼ ä¸€èŠ‚ä¸­ï¼Œæœ€åä¸€æ­¥åœåœ¨äº†` NativeInputEventReceiver#nativeInit()` æ–¹æ³•ï¼Œåˆ©ç”¨ Looper ç›‘å¬äº† `socketfd`

ç°åœ¨æˆ‘ä»¬æ¥èŠèŠï¼š**å½“ `socketfd` æœ‰æ¶ˆæ¯æ—¶ï¼ŒAPP ç«¯ä¼šæ€ä¹ˆå¤„ç†ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆåˆ†å‘åˆ°æ ¹ View çš„ï¼Ÿ**

```c++
/frameworks/base/core/jni/android_view_InputEventReceiver.cpp
class NativeInputEventReceiver {

    int NativeInputEventReceiver::handleEvent( receiveFd, events, data) {
        switch (type) { // ç®€ç•¥å†™æ³•ï¼Œè¿™æ˜¯ consumeEvents() æ–¹æ³•ä¸­çš„é€»è¾‘
            case AINPUT_EVENT_TYPE_KEY: {
                inputEventObj = factory->createKeyEvent(); // è½¬æ¢ä¸ºæŒ‰é”®ç±»å‹äº‹ä»¶ KeyEvent
            }
            case AINPUT_EVENT_TYPE_MOTION: {
                inputEventObj = factory->createMotionEvent(); // è½¬è½¬ä¸ºè§¦æ‘¸ç±»å‹äº‹ä»¶ MotionEvent
            }
        }
        env->CallVoidMethod(receiverObj.get(),dispatchInputEvent, seq, inputEventObj); // å›è°ƒåˆ° Java
    }
}
```

APP ç«¯çš„ `socketfd` å‘ç”Ÿäº‹ä»¶å˜åŒ–æ—¶ï¼ŒLooper æ ¹æ®æŒ‡å®šçš„å›è°ƒåœ°å€ï¼Œè°ƒç”¨åˆ° `NativeInputEventReceiver#handleEvent()` æ–¹æ³•

åœ¨ `NativeInputEventReceiver#handleEvent()` æ–¹æ³•ä¸­ï¼Œæ ¹æ®äº‹ä»¶ç±»å‹ï¼Œåˆ›å»ºä¸åŒçš„äº‹ä»¶å¯¹è±¡

æœ€åï¼Œåˆ©ç”¨ `CallVoidMethod` å›è°ƒ Java æ–¹æ³•ï¼Œå°†äº‹ä»¶ä¼ é€’åˆ° Java å±‚çš„ `InputEventReceiver#dispatchInputEvent()` æ–¹æ³•

```java
/frameworks/base/core/java/android/view/InputEventReceiver.java
abstract class InputEventReceiver {

    // Called from native code.
    private void dispatchInputEvent(int seq, InputEvent event) {
        onInputEvent(event);
    }
}

/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl extends InputEventReceiver {
    
    class WindowInputEventReceiver extends InputEventReceiver {

        @Override
        public void onInputEvent(InputEvent event) {
            enqueueInputEvent(event, this, 0, true);
        }
    }

    void enqueueInputEvent(InputEvent event,InputEventReceiver receiver, int flags, boolean processImmediately) {
        ...
        // æ‰§è¡Œæ¶ˆæ¯å…¥åˆ—ä»¥åï¼Œæ¥ç€è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æµæ°´çº¿è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸å…³å¿ƒï¼Œç›´æ¥æ¥çœ‹ processPointerEvent() æ–¹æ³•
        // input æ¶ˆæ¯åˆ°è¾¾ ViewRootImpl åï¼ŒGoogle ä½¿ç”¨è´£ä»»é“¾çš„æ¨¡å¼ï¼Œå°†è¾“å…¥äº‹ä»¶æ‹†åˆ†ä¸º KeyEvent å’Œ MotionEvent ä¸¤ç§ç±»å‹ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç†
        //
        if(event.getType == input) processPointerEvent(event);
        if(event.getType == key) processKeyEvent(event);
    }

    // è´£ä»»é“¾æ¨¡å¼ï¼Œæ¯ä¸ª InputStage è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œé“¾ä¸­çš„æŸä¸ª InputStage çš„ç»“æœä¼šå½±å“å¯¹ä¸‹ä¸€èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œæˆ–åœæ­¢ç»§ç»­åˆ†å‘ç­‰
    // åœ¨ ViewRootImpl#setView() å‡½æ•°ä¸­æŒ‡å®šè´£ä»»é“¾çš„å‰åé¡ºåºï¼Œè¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œè¯·æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—è¡¨ä¸­ã€Šè¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾)ã€‹
    class InputStage {

        // åœ¨ ViewRootImpl ä¸­æœ‰å¥½å‡ ä¸ªåŒå processPointerEvent() æ–¹æ³•ï¼Œ eventTarget é€šå¸¸æ˜¯ ViewRootImpl ä¿å­˜çš„ DecorView å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨åˆ° View#dispatchPointerEvent() æ–¹æ³•
        private int processPointerEvent(QueuedInputEvent q) {
            MotionEvent event = (MotionEvent)q.mEvent;
            final View eventTarget =  mView; // é€šå¸¸æ˜¯ DecorView
            boolean handled = eventTarget.dispatchPointerEvent(event);
            ...
            return handled ? FINISH_HANDLED : FORWARD;
        }

        private int processKeyEvent(QueuedInputEvent q) {
            KeyEvent event = (KeyEvent)q.mEvent;
            mView.dispatchKeyEvent(event)
            final View eventTarget =  mView; // é€šå¸¸æ˜¯ DecorView
            boolean handled = eventTarget.dispatchPointerEvent(event);
            ...
            return handled ? FINISH_HANDLED : FORWARD;
        }

    }

}
```

InputEventReceiver æ˜¯æŠ½è±¡ç±»ï¼Œåœ¨ `dispatchInputEvent()` æ–¹æ³•ä¸­å›è°ƒ `onInputEvent()` æ–¹æ³•ã€‚

è€Œ ViewRootImpl çš„å†…éƒ¨ç±» `WindowInputEventReceiver` å®ç°äº† InputEventReceiver ç±»ï¼Œå¹¶ä¸”åœ¨ `onInputEvent()` å†…éƒ¨åˆè°ƒç”¨äº† `enqueueInputEvent()` å…¥åˆ—è¾“å…¥æ¶ˆæ¯

æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çš„åˆ†å‘é€»è¾‘å…¨éƒ¨éƒ½å‘ç”Ÿåœ¨ `ViewRootImpl#enqueueInputEvent()` æ–¹æ³•ä¸­

èƒœåˆ©çš„æ›™å…‰å°±åœ¨å‰æ–¹ï¼Œç»§ç»­å†²

```java
/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl extends InputEventReceiver {

    void enqueueInputEvent(InputEvent event,InputEventReceiver receiver, int flags, boolean processImmediately) {
        if(event.getType == input) processPointerEvent(event);
        if(event.getType == key) processKeyEvent(event);
    }

    class InputStage {

        private int processPointerEvent(QueuedInputEvent q) {
            MotionEvent event = (MotionEvent)q.mEvent;
            final View eventTarget =  mView; // é€šå¸¸æ˜¯ DecorView
            boolean handled = eventTarget.dispatchPointerEvent(event);
            ...
            return handled ? FINISH_HANDLED : FORWARD;
        }

        private int processKeyEvent(QueuedInputEvent q);// å¤„ç† key äº‹ä»¶ï¼Œå¿½ç•¥
    }

}
```

`input` æ¶ˆæ¯åˆ°è¾¾ ViewRootImpl åï¼Œå°†è¾“å…¥äº‹ä»¶æ‹†åˆ†ä¸º` KeyEvent` å’Œ `MotionEvent` ä¸¤ç§ç±»å‹ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç†

Google å›¢é˜Ÿä½¿ç”¨äº†`è´£ä»»é“¾æ¨¡å¼`æ¥å¤„ç†äº‹ä»¶æ¶ˆæ¯ï¼Œæ¯ä¸ª `InputStage` è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œé“¾ä¸­çš„æŸä¸ª `InputStage` çš„ç»“æœä¼šå½±å“å¯¹ä¸‹ä¸€èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œæˆ–åœæ­¢åˆ†å‘ç­‰

`ViewRootImpl#setView()` å‡½æ•°ä¸­æŒ‡å®šäº†è´£ä»»é“¾æ‰§è¡Œçš„å‰åé¡ºåºï¼Œæˆ‘ä»¬è¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—è¡¨ä¸­[ã€Šè¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾)ã€‹](https://juejin.cn/post/6925336861137174541)

ä¸ºäº†çœäº‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ `processPointerEvent()` å¤„ç†è§¦æ‘¸äº‹ä»¶çš„æ–¹æ³•

åœ¨ `processPointerEvent()` æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯å°† `InputEvent` å¼ºè½¬ä¸º `MotionEvent` ï¼Œç„¶åï¼Œè°ƒç”¨ `mView` çš„ `dispatchPointerEvent()` æ–¹æ³•æ‰§è¡Œåˆ†å‘

## è§¦æ‘¸äº‹ä»¶åˆ°è¾¾ DecorView

äº†è§£ Window åˆ›å»ºæµç¨‹çš„æœ‹å‹è‚¯å®šçŸ¥é“ï¼Œ`mView` å°±æ˜¯ DecorView ï¼Œé‚£è¿™é‡Œå…¶å®è°ƒç”¨çš„æ˜¯ `DecorView#dispatchPointerEvent()` æ‰§è¡Œåˆ†å‘ï¼Œæ¥ç€æ¥è·Ÿè¸ª

```java
/frameworks/base/core/java/android/view/View.java
class View {

    public final boolean dispatchPointerEvent(MotionEvent event) {
        if (event.isTouchEvent()) {
            return dispatchTouchEvent(event);
        } else {
            return dispatchGenericMotionEvent(event);
        }
    }
}
```

DecorView ç»§æ‰¿è‡ª `FrameLayout` ï¼ŒFrameLayout ç»§æ‰¿è‡ª `ViewGroup` ï¼ŒViewGroup ç»§æ‰¿è‡ª `View`

View çš„ `dispatchPointerEvent()` æ˜¯ `final` å…³é”®å­—ä¿®é¥°çš„ï¼Œä¸å…è®¸å­ç±»é‡å†™

æ‰€ä»¥ï¼Œè°ƒç”¨ `DecorView#dispatchPointerEvent()` å®é™…çš„æ‰§è¡Œè€…æ˜¯ View

åœ¨ `View#dispatchPointerEvent()` æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œé‚£è‚¯å®šæ˜¯å•Š

æ¥ç€è°ƒç”¨ `dispatchTouchEvent()` æ–¹æ³•æ‰§è¡Œåˆ†å‘

`dispatchTouchEvent()` æ²¡æœ‰è¢« `final` ä¿®é¥°ï¼Œå¯ä»¥è¢«é‡å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å›åˆ° DecorView çš„ `dispatchTouchEvent()` æ–¹æ³•ä¸­

```java
/frameworks/base/core/java/com/android/internal/policy/DecorView.java
class DecorView extends FrameLayout {
    
    @Override
    public boolean dispatchTouchEvent(MotionEvent ev) {
        Window.Callback cb = mWindow.getCallback(); // ç»™ Activity å’Œ Dialog æ‹¦æˆªäº‹ä»¶çš„æœºä¼š
        return cb != null ? cb.dispatchTouchEvent(ev) : super.dispatchTouchEvent(ev);
    }
}
```

åœ¨ `DecorView#dispatchTouchEvent()` æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯åˆ¤æ–­äº† `mWindow` æŒæœ‰çš„ Callback æ˜¯å¦ä¸ºç©º

è¿™é‡Œä¸´æ—¶è¡¥å……ä¸¤ä¸ªå°ç»†èŠ‚

1. **Window.Callback æ˜¯ä¸ªæ¥å£ï¼Œè€Œ Activity å’Œ Dialog éƒ½å®ç°äº†è¿™ä¸ªæ¥å£**
2. **DecorView æŒæœ‰çš„ `mWindow` çš„èµ‹å€¼è·¯å¾„æ˜¯è¿™æ ·çš„ï¼š`PhoneWindow#setContentView()` -> `installDecor()` -> `generateDecor()` -> `DecorView#setWindow()`ï¼Œä¸å±•å¼€è®¨è®ºäº†**

æ¥ç€çœ‹ä»£ç ï¼Œå¦‚æœ `mWindow` çš„ Callback ä¸ä¸ºç©ºï¼Œåˆ™ä¼˜å…ˆè°ƒç”¨ Callback çš„ `dispatchTouchEvent()` å‡½æ•°æ‰§è¡Œåˆ†å‘

æˆ‘ä»¬ä»¥ Activity æ¥ä¸¾ä¾‹

```java
/frameworks/base/core/java/android/app/Activity.java
class Activity {
    
    public boolean dispatchTouchEvent(MotionEvent ev) {
        if (getWindow().superDispatchTouchEvent(ev)) {
            return true;
        }
        return onTouchEvent(ev);
    }

    public boolean onTouchEvent(MotionEvent event) {
        ...
    }
}

/frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
class PhoneWindow {
    public boolean superDispatchTouchEvent(MotionEvent event) {
        return mDecor.superDispatchTouchEvent(event);
    }
}

/frameworks/base/core/java/com/android/internal/policy/DecorView.java
class DecorView extends FrameLayout {
    
    public boolean superDispatchTouchEvent(MotionEvent event) {
        return super.dispatchTouchEvent(event);
    }
}
```

Activity çš„ `dispatchTouchEvent()` æ–¹æ³•è¢«è°ƒç”¨åï¼Œå…ˆè°ƒç”¨äº† `getWindow().superDispatchTouchEvent(ev)` æ‰§è¡Œåˆ†å‘ï¼Œæ²¡äººå¤„ç†å†è°ƒç”¨è‡ªèº«çš„ `onTouchEvent() `æ–¹æ³•

è€Œ `getWindow().superDispatchTouchEvent()` æ–¹æ³•å…œå…œè½¬è½¬ä¸€åœˆï¼Œè¿˜æ˜¯è°ƒç”¨åˆ° `DecorView#superDispatchTouchEvent()` ä¸­

å‰é¢è¯´è¿‡äº†ï¼ŒDecorView ç»§æ‰¿è‡ª FrameLayout ï¼ŒFrameLayout æ˜¯æ²¡æœ‰é‡å†™ `dispatchTouchEvent()` æ–¹æ³•çš„ï¼ŒFrameLayout ç»§æ‰¿è‡ª ViewGroup ï¼ŒViewGroup é‡å†™äº† `dispatchTouchEvent()`

æ‰€ä»¥ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ†å‘çš„è¿˜æ˜¯ `ViewGroup#dispatchTouchEvent()` æ–¹æ³•

**åˆç€ç»•äº†ä¸€åœˆï¼ŒActivity æ˜¯å•¥ä¹Ÿæ²¡åšæ˜¯å§ï¼Ÿ**

ummmm~  æ˜¯çš„

ä¸è¿‡ï¼Œæˆ‘è§‰å¾—è¿™æ ·çš„è®¾è®¡æ˜¯åœ¨ç»™ `Activity` / `Dialog` æ‹¦æˆªäº‹ä»¶çš„æœºä¼šï¼Œæ¯•ç«Ÿå¦‚æœæˆ‘ä»¬åœ¨ Activity ä¸­é‡å†™äº† `dispatchTouchEvent()` æ–¹æ³•ï¼Œæ˜¯å¯ä»¥è®©æ•´æ£µ View æ ‘éƒ½æ¥æ”¶ä¸åˆ°è§¦æ‘¸äº‹ä»¶çš„

å¥½ï¼Œç°åœ¨è§¦æ‘¸äº‹ä»¶åˆ†å‘çš„èµ·ç‚¹åˆ°äº†æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ `ViewGroup#dispatchTouchEvent()` è¿™é‡Œ

æ¥ä¸‹æ¥çš„ä¸€æ•´ç« ï¼Œæˆ‘ä»¬æ¥å¤ä¹  View / ViewGroup äº‹ä»¶åˆ†å‘çš„æµç¨‹

# ä¸‰ã€è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹ï¼ˆApplicationï¼‰

åœ¨ä¹‹å‰çš„ä¸¤èŠ‚å†…å®¹ä¸­ï¼Œä¸€ä¸ª `input` äº‹ä»¶ä¸€è·¯ä»ç¡¬ä»¶é©±åŠ¨ï¼ŒæˆåŠŸçš„åˆ°è¾¾åº”ç”¨çš„ `DecorView`

æˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼ŒæŠŠè¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™æŸä¸ªå…·ä½“çš„ View æˆ–è€…æ˜¯ ViewGroup

æ­£æ–‡å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠè§¦æ‘¸äº‹ä»¶çš„æœ¬ä½“ï¼š`MotionEvent`

`MotionEvent` è¡¨ç¤ºä¸€ä¸ª`è§¦æ‘¸äº‹ä»¶`ï¼Œé‡Œé¢åŒ…å«äº†äº‹ä»¶çš„ç±»å‹ï¼Œè§¦æ‘¸çš„ä½ç½®ä¿¡æ¯ç­‰ï¼Œå¯¹åˆ†å‘è€…æ¥è¯´ï¼Œäº‹ä»¶çš„ç±»å‹éå¸¸é‡è¦ï¼Œæ¥ç®€å•è®¤è¯†ä¸€ä¸‹

- **`ACTION_DOWN`ï¼š æŒ‰ä¸‹å±å¹•**
- **`ACTION_MOVE`ï¼šæ‰‹æŒ‡æ»‘åŠ¨**
- **`ACTION_UP`ï¼šæŠ¬èµ·æ‰‹æŒ‡ï¼Œç¦»å¼€å±å¹•**
- **`ACTION_CANCEL`ï¼šéæ­£å¸¸æŠ¬èµ·ï¼Œå‡ ä¹ç­‰åŒäº `ACTION_UP` ï¼Œé€šå¸¸æ˜¯çˆ¶è§†å›¾æ‹¦æˆª**
- **`ACTION_POINTER_DOWN`ï¼šå¤šæŒ‡è§¦æ‘¸ï¼Œè¡¨ç¤ºå·²ç»æœ‰ä¸€åªæ‰‹æŒ‡æŒ‰ä¸‹æ—¶ï¼Œå¦æœ‰ä¸€åªæ‰‹æŒ‡å†æ¬¡æŒ‰ä¸‹**
- **`ACTION_POINTER_UP`ï¼šå¤šæŒ‡è§¦æ‘¸ï¼Œè¡¨ç¤ºå±å¹•ä¸Šå·²ç»æœ‰å¤šä¸ªæ‰‹æŒ‡ï¼ŒæŠ¬èµ·å…¶ä¸­ä¸€åªæ‰‹æŒ‡åè§¦å‘çš„äº‹ä»¶**

å‡ ç§å¸¸ç”¨è§¦æ‘¸çš„ç±»å‹å°±è¿™ä¹ˆå¤šï¼Œæœ€åä¸¤ç§æ˜¯å¤šæŒ‡è§¦æ‘¸çš„æƒ…å†µä¸‹æ‰ä¼šæ”¶åˆ°çš„äº‹ä»¶ç±»å‹ï¼Œæœ¬æ–‡æˆ‘ä»¬ä¸æ‰“ç®—è®¨è®ºå¤šæŒ‡è§¦æ‘¸ï¼ˆ*åŒ…æ‹¬ TouchTarget*ï¼‰ï¼Œæ‰€ä»¥åé¢ä¼šå¿½ç•¥æ‰

åœ¨ä¸€æ¬¡äº‹ä»¶åˆ†å‘ä¸­ï¼Œä»¥æ¯ä¸ª `DOWN` äº‹ä»¶ä¸ºå¼€å§‹ï¼Œ `UP` / `CANCEL` äº‹ä»¶ä¸ºåœæ­¢ï¼Œåœ¨ `DOWN` -> `MOVE` -> `MOVE` -> `UP` / `CANCEL` æ•´ä¸ªè¿‡ç¨‹çœ‹åšæ˜¯ä¸€ä¸ªäº‹ä»¶åºåˆ—

## ViewGroup çš„æ¶ˆè´¹ã€åˆ†å‘ã€æ‹¦æˆªä¸æ”¾è¡Œ

åœ¨è¿›å…¥ ViewGroup çš„æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š**ä»€ä¹ˆæ˜¯äº‹ä»¶åˆ†å‘ï¼Ÿ**

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Android å›¾å½¢ç³»ç»Ÿä¸­ï¼Œä¸»è¦ç»˜å›¾çš„ä»»åŠ¡æ˜¯äº¤ç»™ View å»å®Œæˆçš„ï¼ŒViewGroup æ˜¯ä½œä¸ºç®¡ç†è§†å›¾çš„å®¹å™¨ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ‘†æ”¾å­ Viewï¼Œè‡ªèº«åˆ™åŸºæœ¬ä¸å‚ä¸ç»˜å›¾æ“ä½œ

ä½†æ˜¯åœ¨è§¦æ‘¸äº‹ä»¶çš„åˆ†å‘ä¸­ï¼ŒViewGroup å¯¹è§¦æ‘¸äº‹ä»¶çš„æ€åº¦å°±å˜äº†ï¼Œå› ä¸ºå®ƒå’Œå­ View ä¸€æ ·ï¼Œéƒ½å¯èƒ½éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶

### 1ã€ViewGroup å››ç§åœºæ™¯

ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ä¸€ä¸ªå¯ä»¥çºµå‘æ»‘åŠ¨çš„ ViewGroup ï¼Œé‡Œé¢æ‘†æ»¡äº† `TextView` ï¼Œç”¨æˆ·åœ¨æ»‘åŠ¨å±å¹•æ—¶ï¼Œè‚¯å®šæ˜¯æœŸæœ›å±•ç¤ºæ›´å¤šå†…å®¹çš„ã€‚é‚£ä¹ˆè¿™æ—¶å€™ï¼Œå°±éœ€è¦ ViewGroup å¯¹å­ View é‡æ–°å¸ƒå±€æ‘†æ”¾ï¼Œå°†éšè—åœ¨å±å¹•åº•éƒ¨çš„å­ View æ˜¾ç¤ºå‡ºæ¥

![android_graphic_v5_viewgroup_consumed](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_viewgroup_consumed.GIF)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„*

ä¸Šé¢çš„åœºæ™¯ä¸­ï¼ŒViewGroup å¿…é¡»è¦æ‹¿åˆ°ç”¨æˆ·æ»‘åŠ¨å±å¹•çš„æ•°æ®ï¼Œæ‰èƒ½è®¡ç®—å±•ç¤ºå¤šå°‘è§†å›¾æ‰ç®—åˆé€‚

**å³ï¼ŒViewGroup éœ€è¦æ¶ˆè´¹è§¦æ‘¸äº‹ä»¶**

å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªä¸æ”¯æŒæ»‘åŠ¨çš„ ViewGroup ä¸­ï¼Œæœ‰ä¸ªå±…ä¸­æ˜¾ç¤ºçš„ `Button` æŒ‰é’®

![android_graphic_v5_viewgroup_dispatch](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_viewgroup_dispatch.GIF)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„*

ç”¨æˆ·æŒ‰ä¸‹å±å¹•åï¼ŒViewGroup è‚¯å®šæ¯”è‡ªå·±çš„å­ View è¦ä¼˜å…ˆæ‹¿åˆ°è§¦æ‘¸äº‹ä»¶

è€Œ ViewGroup è‡ªèº«åˆä¸éœ€è¦è¿™ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆï¼Œå®ƒå°±éœ€è¦æ ¹æ®è§¦æ‘¸ä½ç½®å»æŸ¥æ‰¾ï¼Œæœ‰æ²¡æœ‰å­ View éœ€è¦è¯¥äº‹ä»¶

ç»è¿‡è®¡ç®—ï¼Œå¦‚æœå‘ç°ç”¨æˆ·æŒ‰åäº†ï¼Œæ²¡ç‚¹åˆ° `Button` ï¼Œé‚£å°±ä¸ç®¡äº†ï¼Œ`dispatchTouchEvent()` è¿”å› false ï¼Œçˆ±è°æ¶ˆè´¹è°æ¶ˆè´¹ï¼Œåæ­£æˆ‘ä¸è¦

å¦‚æœå‘ç°ç”¨æˆ·æŒ‰åˆ°äº†ä¸­é—´çš„ `Butto`n ï¼Œè¿™æ—¶å€™ ViewGroup å°±éœ€è¦æŠŠè¿™ä¸ªäº‹ä»¶äº¤ç»™ `Button` ï¼Œè¯¢é—®å­ View è¦ä¸è¦æ¶ˆè´¹

**å³ï¼Œ ViewGroup éœ€è¦åˆ†å‘äº‹ä»¶**

å†å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ”¯æŒçºµå‘æ»‘åŠ¨çš„ ViewGroup ä¸­ï¼Œæœ‰ä¸ªå±…ä¸­æ˜¾ç¤ºçš„ `Button` æŒ‰é’®

ç°åœ¨ï¼Œç”¨æˆ·æŒ‰ä¸‹äº†å±å¹•ä¸­çš„ `Button` ï¼ŒViewGroup è§‰å¾—ä¸æ˜¯æ»‘åŠ¨äº‹ä»¶ï¼Œå°±æŠŠè¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™äº† `Button`

ä½†æ˜¯ç”¨æˆ·åœ¨æŒ‰ä¸‹ `Button` åï¼Œæ¥ç€åˆå¼€å§‹æ»‘åŠ¨å±å¹•äº†

![android_graphic_v5_viewgroup_intercept](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_viewgroup_intercept.GIF)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„*

æ­¤æ—¶çš„ ViewGroup éœ€è¦è®¡ç®—æ»‘åŠ¨è·ç¦»ï¼Œæ‰€ä»¥æ˜¯éœ€è¦è¿™ä¸ªè§¦æ‘¸äº‹ä»¶çš„ï¼Œé‚£åªèƒ½å¯¹ä¸èµ· `Button` äº†ï¼ŒViewGroup ä¼šæŠŠæœ¬æ¥å‡†å¤‡åˆ†å‘ç»™ `Button` çš„äº‹ä»¶æ‹¦æˆªæ¶ˆè´¹æ‰

**å³ï¼ŒViewGroup éœ€è¦æ‹¦æˆªäº‹ä»¶**

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ä¸€ç§æç«¯æƒ…å†µï¼š**å¦‚æœå­ View å’Œ ViewGroup éƒ½éœ€è¦è§¦æ‘¸äº‹ä»¶ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ**

æŒ‰æ­£å¸¸çš„æ‹¦æˆªé€»è¾‘ï¼ŒViewGroup å…ˆæ‹¿åˆ°äº‹ä»¶ï¼Œè‡ªå·±åˆæœ‰æ¶ˆè´¹çš„éœ€æ±‚ï¼Œè‚¯å®šæ˜¯ç´§ç€è‡ªå·±ç”¨

ä½†æ˜¯ï¼Œæ€»ä¼šæœ‰åœºæ™¯éœ€è¦å°†äº‹ä»¶ä¼˜å…ˆåˆ†å‘ç»™å­è§†å›¾ï¼Œæ¯”å¦‚ï¼š

åœ¨ä¸€ä¸ªæ”¯æŒçºµå‘æ»šåŠ¨çš„ ViewGroup ï¼Œå®ƒçš„ä¸¤ä¸ªå­ View åŒæ ·æ˜¯æ”¯æŒçºµå‘æ»šåŠ¨çš„ ViewGroup ï¼Œä¸¤ä¸ªå­ View åˆ†åˆ«éƒ½åŒ…å«è‹¥å¹² `TextView `

ç°åœ¨çš„éœ€æ±‚æ˜¯ï¼š**é•¿æŒ‰æŸä¸€ä¸ª `TextView` æ—¶ï¼Œå…è®¸è¯¥ `TextView` ä¸Šä¸‹è‡ªç”±æ‹–åŠ¨**

![android_graphic_v5_viewgroup_request](/Users/bob/Desktop/Bob/workspace/androidstudio/Blackboard/Blog/src/main/java/com/android/blog/android/graphics/imgs/v5/android_graphic_v5_viewgroup_request.GIF)

*å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„*

å½“ç”¨æˆ·é•¿æŒ‰ `TextView` ç§»åŠ¨æ—¶ï¼Œé¢„æœŸæ˜¯ç§»åŠ¨è¿™ä¸ª `TextView`ï¼Œç†è®ºä¸Šè¿™ä¸ªç§»åŠ¨äº‹ä»¶åº”è¯¥è¢« `TextView` çš„çˆ¸çˆ¸æ¶ˆè´¹æ‰ï¼Œå› ä¸ºéœ€è¦é‡æ–°å¸ƒå±€ç»˜åˆ¶ï¼›

ä½†å®é™…ä¸Šæ˜¯ `TextView` çš„çˆ·çˆ·æ¶ˆè´¹æ‰çš„ï¼Œå› ä¸ºçˆ·çˆ·è§‰å¾—ç”¨æˆ·æ˜¯åœ¨æ»‘åŠ¨å±å¹•ï¼Œè¦æŠŠå±å¹•ä¸‹æ–¹æ›´å¤šçš„è§†å›¾æ˜¾ç¤ºå‡ºæ¥

**ViewGroup å’Œ ViewGroup ä¸­çš„å­ View éƒ½æƒ³è¦æ¶ˆè´¹äº‹ä»¶ï¼ˆæ»‘åŠ¨å†²çªï¼‰ï¼Œè¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿ**

å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ç§æœºåˆ¶ï¼Œè®© ViewGroup çŸ¥é“å­ View ä¹Ÿéœ€è¦è¿™ä¸ªäº‹ä»¶

æˆ‘ä»¬æš‚ä¸”æŠŠè¿™å¥—æœºåˆ¶ç§°ä¹‹ä¸º â€œè¯·æ±‚æ”¾è¡Œâ€ å¥½äº†

 ViewGroup ä¸ºå­ View å¼€æ”¾ä¸€ä¸ªè¯·æ±‚æ”¾è¡Œçš„æ¥å£ï¼Œå½“ ViewGroup æ”¶åˆ°æ¥è‡ªå­ View çš„æ”¾è¡Œè¯·æ±‚æ—¶ï¼Œä¼˜å…ˆå°†äº‹ä»¶åˆ†å‘ç»™å­ Viewï¼Œè¿™æ ·ï¼Œé—®é¢˜å°±è§£å†³äº†

**è§¦æ‘¸äº‹ä»¶çš„`æ¶ˆè´¹`ã€`æ‹¦æˆª`ã€`æ”¾è¡Œ`ä¸`åˆ†å‘`ï¼Œè¿™å››ç§æƒ…å†µå‡ ä¹è¦†ç›–äº† ViewGroup å¯¹è§¦æ‘¸äº‹ä»¶å¤„ç†ï¼ˆå•æŒ‡ï¼‰çš„æ‰€æœ‰åœºæ™¯**

å¥½ï¼Œç°åœ¨ ViewGroup çš„éœ€æ±‚åŸºæœ¬ä¸Šäº†è§£æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹æºç ä¸­ï¼Œ Google æ˜¯æ€ä¹ˆè¿›è¡Œä»£ç è®¾è®¡çš„

### 2ã€äº‹ä»¶çš„æ”¾è¡Œå’Œæ‹¦æˆª

ç¬¬äºŒç« ç»“æŸæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨åœåœ¨äº† `ViewGroup#dispatchTouchEvent()` æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ª View / ViewGroup äº‹ä»¶åˆ†å‘çš„èµ·æº

```java
/frameworks/base/core/java/android/view/ViewGroup.java
class ViewGroup extends View {

    public boolean dispatchTouchEvent(MotionEvent ev) {
        int actionMasked = ev.getAction() & MotionEvent.ACTION_MASK;
        TouchTarget newTouchTarget = null;
        boolean intercepted;
      	boolean handled = false;
        if (actionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != null) {
            // æ£€æŸ¥å­è§†å›¾æ˜¯å¦è°ƒç”¨äº† requestDisallowInterceptTouchEvent(true) è¯·æ±‚æ”¾è¡Œ
            boolean disallowIntercept = (mGroupFlags & FLAG_DISALLOW_INTERCEPT) != 0;
            if (!disallowIntercept) {
              intercepted = onInterceptTouchEvent(ev); // å­è§†å›¾æœªè¯·æ±‚æ”¾è¡Œï¼Œè¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦éœ€è¦æ¶ˆè´¹
            } else {
              intercepted = false;
            }
        } else {
            intercepted = true; // å¦‚æœ mFirstTouchTarget ä¸ºç©ºï¼Œå¹¶ä¸”äº‹ä»¶ç±»å‹ä¸ä¸º DOWN ï¼Œè¡¨ç¤ºå…ˆå‰çš„äº‹ä»¶ä¹Ÿæ˜¯ ViewGroup è‡ªå·±æ¶ˆè´¹çš„ï¼Œæ— éœ€æ‰§è¡Œåˆ†å‘ï¼Œå†æ¬¡äº¤ç»™è‡ªå·±æ‰§è¡Œå³å¯
        }
        return handled;
    }

    public boolean onInterceptTouchEvent(MotionEvent ev) {
        //è¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦éœ€è¦å¤„ç†äº‹ä»¶
        return false;
    }
  
    public void requestDisallowInterceptTouchEvent(boolean disallowIntercept) {
      	if (disallowIntercept) {
          	mGroupFlags |= FLAG_DISALLOW_INTERCEPT;
      	} else {
          	mGroupFlags &= ~FLAG_DISALLOW_INTERCEPT;
      	}
  	}
}
```

ViewGroup çš„å‡ ç§åœºæ™¯æˆ‘ä»¬å·²ç»åœ¨ä¸Šé¢ä»‹ç»è¿‡äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹ç…§æºç è§£é‡Šçš„è¿‡ç¨‹ï¼Œæ¯”è¾ƒè½»æ¾

åœ¨äº‹ä»¶åˆ†å‘çš„å¼€å§‹ï¼Œå…ˆæ˜¯åˆ¤æ–­äº†äº‹ä»¶æ˜¯å¦æ˜¯ `DOWN` ç±»å‹ï¼Œæˆ–è€… `mFirstTouchTarget` å˜é‡æ˜¯å¦ä¸ä¸ºç©ºï¼ˆ*`mFirstTouchTarget` è®°å½•çš„æ˜¯æ¶ˆè´¹ä¸Šä¸€æ¬¡ `DOWN` äº‹ä»¶çš„æ˜¯è°*ï¼‰

æ»¡è¶³æ¡ä»¶åˆ™è¿›å…¥ â€œæ£€æŸ¥æ”¾è¡Œâ€ å’Œ â€œæ£€æŸ¥æ˜¯å¦è¦æ‹¦æˆªâ€ çš„é€»è¾‘

`disallowIntercept` ä¸º true ï¼Œè¡¨ç¤ºå­è§†å›¾æ˜¯å¦è°ƒç”¨äº† `requestDisallowInterceptTouchEvent(true)` æ–¹æ³•è¯·æ±‚æ”¾è¡Œï¼Œå°† `intercepted` æ ‡è¯†ç½®ä¸ºfalse ï¼Œå¹¶ä¸”ï¼Œæœ¬æ¬¡äº‹ä»¶å°†ä¸è¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦è¦æ¶ˆè´¹

`**ViewGroup#requestDisallowInterceptTouchEvent()` æ–¹æ³•å°±æ˜¯ä¹‹å‰ä»‹ç»è¿‡çš„ï¼Œå¼€æ”¾ç»™å­ View è¯·æ±‚æ”¾è¡Œçš„ä¸€å¥—æœºåˆ¶**

å¦‚æœå­è§†å›¾æ²¡æœ‰è¯·æ±‚æ”¾è¡Œï¼Œé‚£ä¹ˆè°ƒç”¨ `onInterceptTouchEvent()` è¯¢é—®è‡ªå·±è¦ä¸è¦æ‹¦æˆªæ¶ˆè´¹ï¼Œä¸éœ€è¦æ¶ˆè´¹äº‹ä»¶ä¼šç»§ç»­åˆ†å‘ï¼Œæˆ‘ä»¬åé¢ä¼šè®²åˆ°

å¦‚æœ `mFirstTouchTarget` ä¸ºç©ºï¼Œå¹¶ä¸”äº‹ä»¶ç±»å‹ä¸ä¸º `DOWN` ï¼Œè¡¨ç¤ºå…ˆå‰çš„äº‹ä»¶ä¹Ÿæ˜¯ ViewGroup è‡ªå·±æ¶ˆè´¹çš„ï¼Œæ— éœ€æ‰§è¡Œåˆ†å‘ï¼Œå†æ¬¡äº¤ç»™è‡ªå·±æ‰§è¡Œå³å¯ï¼Œå°† `intercepted` å˜é‡ç½®ä¸º true

ä¸Šé¢è¿™æ®µä»£ç è§£é‡Šå®Œäº†ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å¾—åˆ°çš„ä¿¡æ¯ï¼š

**åªè¦å­ View æ²¡æœ‰è°ƒç”¨ `requestDisallowInterceptTouchEvent()` æ–¹æ³•è¯·æ±‚æ”¾è¡Œï¼ŒViewGroup æœ‰æƒåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œé€šè¿‡è°ƒç”¨ `onInterceptTouchEvent()` è¿”å› true çš„æ–¹å¼ï¼Œæ‹¦æˆªä»»ä¸€è§¦æ‘¸äº‹ä»¶**

æˆ‘ä»¬åœ¨ç»§æ‰¿ ViewGroup ä»¥åï¼Œé¦–å…ˆè¦é‡å†™ `onInterceptTouchEvent()` æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåˆ¤æ–­è¦ä¸è¦æ¶ˆè´¹æŸä¸ªäº‹ä»¶

true è¡¨ç¤ºè‡ªèº«éœ€è¦æ¶ˆè´¹ï¼Œè¯¥äº‹ä»¶å°†ä¼šè¢«æ‹¦æˆªï¼Œå¹¶ä¼šåœ¨ä¸‹ä¸€æ­¥å‘é€åˆ° ViewGroup è‡ªèº«çš„ `onTouchEvent()` æ–¹æ³•ä¸­ï¼Œä¸ä¼šç»§ç»­å‘ä¸‹åˆ†å‘

false è¡¨ç¤ºä¸æ¶ˆè´¹ï¼Œç»§ç»­å‘ä¸‹åˆ†å‘äº‹ä»¶

ViewGroup çš„æ”¾è¡Œæœºåˆ¶å’Œæ‹¦æˆªå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼Œä¸‹ä¸€æ­¥è¯¥æ‰§è¡Œäº‹ä»¶çš„åˆ†å‘äº†

### 3ã€äº‹ä»¶çš„åˆ†å‘

å¦‚æœå­è§†å›¾æ²¡æœ‰è¯·æ±‚æ”¾è¡Œï¼ŒViewGroup è‡ªèº«ä¹Ÿä¸æ¶ˆè´¹ï¼Œé‚£ä¹ˆ `intercepted` æ ‡è¯†ä¸º false ï¼Œè¿›å…¥åˆ†å‘æµç¨‹

```java
/frameworks/base/core/java/android/view/ViewGroup.java
class ViewGroup extends View {

    public boolean dispatchTouchEvent(MotionEvent ev) {
        ...
        // å­è§†å›¾æœªè¯·æ±‚æ”¾è¡Œï¼ŒViewGroup è‡ªèº«ä¹Ÿä¸æ¶ˆè´¹ï¼Œè¿›å…¥åˆ†å‘æµç¨‹
        if (!intercepted) {
            if (actionMasked == MotionEvent.ACTION_DOWN) {
                for (int i = mChildrenCount - 1; i >= 0; i--) {
                    ...// æ£€æŸ¥å­ View æ˜¯å¦å¯è§¦æ‘¸ï¼Œæ˜¯å¦åœ¨è§¦æ‘¸åŒºåŸŸå†…ç­‰ç­‰ï¼Œè¿‡ç¨‹ç•¥
                    // æ‰¾åˆ°åˆé€‚çš„å­ View åï¼Œè°ƒç”¨ dispatchTransformedTouchEvent() æ‰§è¡Œäº‹ä»¶åˆ†å‘ï¼Œå¦‚æœè¿”å› trueï¼Œè®°å½•æœ¬æ¬¡åˆ†å‘
                    if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) {
                        newTouchTarget = addTouchTarget(child, idBitsToAssign); // ç”Ÿæˆä¸€ä¸ªæ–°çš„ TouchTarget å¯¹è±¡ï¼Œç”¨äºè®°å½•æ¶ˆè´¹çš„ View
                        break;
                    }
                }
                // æ²¡æœ‰æ–°çš„éœ€è¦è§¦æ‘¸äº‹ä»¶çš„è§†å›¾ï¼Œé‚£ä¹ˆï¼ŒæŠŠé“¾è¡¨å°¾éƒ¨çš„ TouchTarget æ‹¿å‡ºæ¥ï¼Œåœ¨ä¸‹ä¸€æ­¥æŠŠäº‹ä»¶åˆ†å‘ç»™å®ƒ
                if (newTouchTarget == null && mFirstTouchTarget != null) {
                    newTouchTarget = mFirstTouchTarget;
                    while (newTouchTarget.next != null) {
                        newTouchTarget = newTouchTarget.next;
                    }
                }
            }
        }
        return handled;
    }

    private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,View child, int desiredPointerIdBits) {
        boolean handled;
        if (child == null) {
            handled = super.dispatchTouchEvent(event); // ViewGroup ç»§æ‰¿è‡ª View ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View#dispatchTouchEvent()
        } else {
            handled = child.dispatchTouchEvent(event);
        }
        return handled;
    }

}
```

åˆ†å‘çš„è¿‡ç¨‹æ˜¯å°†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å­ View éƒ½è¯¢é—®ä¸€é

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œä½¿ç”¨ `for` å¾ªç¯éå†æ‰€æœ‰çš„å­ View ï¼Œæ£€æŸ¥æ¯ä¸ªå­ View æ˜¯å¦åœ¨è§¦æ‘¸åŒºåŸŸï¼Œæ˜¯å¦å¯ä»¥è¢«è§¦æ‘¸ç­‰ç­‰

å¦‚æœæ‰¾åˆ°åˆé€‚çš„å­ View ï¼Œè°ƒç”¨ `dispatchTransformedTouchEvent()` æ‰§è¡Œåˆ†å‘ï¼Œå¹¶è®°å½•æ¶ˆè´¹çš„ç»“æœ

æ‰€æœ‰çš„å­ View éå†ä¸€éåï¼Œå¦‚æœå‘ç°æ²¡æœ‰æ¶ˆè´¹çš„è§†å›¾ï¼Œå¹¶ä¸”ï¼Œå½“å‰ `mFirstTouchTarget` ä¸ä¸ºç©ºï¼Œé‚£ç›´æ¥å°†ä¿ç•™ç€ä¸Šä¸€æ¬¡æ¶ˆè´¹çš„ View æœ€è¿‘çš„ä¸€ä¸ª `TouchTarget` æ‹¿å‡ºæ¥ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æ‰§è¡Œ

### 4ã€äº‹ä»¶çš„æ¶ˆè´¹

äº‹ä»¶çš„æ¶ˆè´¹ä»£ç æ¯”è¾ƒç®€å•ï¼š

```java
/frameworks/base/core/java/android/view/ViewGroup.java
class ViewGroup extends View {

    public boolean dispatchTouchEvent(MotionEvent ev) {
      	...
        // è·‘åˆ°è¿™ï¼Œå¦‚æœ mFirstTouchTarget è¿˜æ˜¯ä¸ºç©º ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶ ViewGroup è‡ªèº«è¦æ¶ˆè´¹
        if (mFirstTouchTarget == null) {
            handled = dispatchTransformedTouchEvent(ev,canceled,null,TouchTarget.ALL_POINTER_IDS);
        } else {
            TouchTarget target = mFirstTouchTarget;
            // éå† TouchTarget é“¾è¡¨ï¼Œæ‰§è¡Œäº‹ä»¶åˆ†å‘ï¼Œä»£ç æœ‰å»é‡æ“ä½œï¼Œè¢«æˆ‘åˆ äº†ï¼Œå³ä¹‹å‰åˆ†å‘è¿‡çš„æ–°æ·»åŠ çš„èŠ‚ç‚¹ï¼Œä¸å†æ‰§è¡Œåˆ†å‘
            while (target != null) {
                final TouchTarget next = target.next;
                if (dispatchTransformedTouchEvent(ev, cancelChild,target.child, target.pointerIdBits)) {
                    handled = true;
                }
                target = next;
            }
        }
        return handled;
    }

    private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,View child, int desiredPointerIdBits) {
        boolean handled;
        if (child == null) {
            handled = super.dispatchTouchEvent(event); // ViewGroup ç»§æ‰¿è‡ª View ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View#dispatchTouchEvent()
        } else {
            handled = child.dispatchTouchEvent(event);
        }
        return handled;
    }

}
```

å¦‚æœ `mFirstTouchTarget` ä¸ºç©º ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶ ViewGroup è‡ªèº«è¦æ¶ˆè´¹ï¼Œè°ƒç”¨ `dispatchTransformedTouchEvent()` æ–¹æ³•

åœ¨ `dispatchTransformedTouchEvent()` æ–¹æ³•ä¸­ï¼Œå¦‚æœ child å‚æ•°ä¸ºç©ºï¼Œè¡¨ç¤ºæ˜¯ ViewGroup è¦æ¶ˆè´¹ï¼Œé‚£ä¹ˆè°ƒç”¨ ViewGroup çš„çˆ¶ç±»ï¼š `View#dispatchTouchEvent()`

`dispatchTouchEvent()` æ–¹æ³•æœ€ç»ˆæŠŠäº‹ä»¶ä¼ é€’ç»™ `onTouchEvent()` ï¼Œæˆ‘ä»¬é©¬ä¸Šå°±èƒ½çœ‹åˆ° View çš„æ¶ˆè´¹æµç¨‹äº†

å¦‚æœ `mFirstTouchTarget` å¯¹è±¡ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰å…¶ä»–å­ View æ¶ˆè´¹äº†äº‹ä»¶ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œä¾æ—§è°ƒç”¨ `dispatchTransformedTouchEvent()` æ‰§è¡Œåˆ†å‘

å¥½äº†ï¼ŒViewGroup çš„ `æ¶ˆè´¹`ã€`åˆ†å‘`ã€`æ‹¦æˆª`ä¸`æ”¾è¡Œ`ï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ `View#dispatchTouchEvent()` çš„æµç¨‹

## View çš„æ¶ˆè´¹

èŠå®Œäº† ViewGroup å¯¹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†ï¼Œæˆ‘ä»¬æ¥ç€æ¥èŠ View è¿™è¾¹æ˜¯æ€ä¹ˆå¤„ç†è§¦æ‘¸äº‹ä»¶çš„

åœ¨ä¸Šä¸€èŠ‚çš„ `dispatchTransformedTouchEvent()` æ–¹æ³•ä¸­ï¼Œæ— è®ºæ‰§è¡Œçš„æ˜¯ `super.dispatchTouchEvent(event)` æ–¹æ³•ï¼Œè¿˜æ˜¯ `child.dispatchTouchEvent(event)` æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨åˆ° `View#dispatchTouchEvent()` ä¸­

`View#dispatchTouchEvent()` é€»è¾‘æ¯”è¾ƒå°‘ï¼Œé‡è¦ä»£ç åªæœ‰ä¸€å¥ï¼Œè°ƒç”¨äº† `onTouchEvent()` æ¶ˆè´¹äº‹ä»¶ï¼Œé™¤æ­¤ä¹‹å¤– View çš„äº‹ä»¶åˆ†å‘å°±æ²¡ä»€ä¹ˆå¥½èŠçš„äº†

```java
//frameworks/base/core/java/android/view/View.java
class View {

    public boolean dispatchTouchEvent(MotionEvent event) {
        boolean result = onTouchEvent(event);
        return result;
    }

    public boolean onTouchEvent(MotionEvent event) {
        return false;
    }
}
```

å¥½äº†ï¼ŒView / ViewGroup çš„äº‹ä»¶åˆ†å‘åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå½“ç„¶æˆ‘ä»¬çœ‹åˆ°çš„æ˜¯éå¸¸ç²¾ç®€çš„ç‰ˆæœ¬äº†ï¼Œåªæœ‰ä¸‰ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼Œå¹¶ä¸”å‡ ä¹æ²¡æœ‰ä»»ä½•ç»†èŠ‚

å› ä¸º View / ViewGroup çš„äº‹ä»¶åˆ†å‘æ¯”è¾ƒç®€å•ï¼Œä¸åƒ Framework çš„é€»è¾‘ï¼Œç»•æ¥ç»•å»çš„ï¼Œäº‹ä»¶åˆ†å‘çš„é€»è¾‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨å†…éƒ¨åšè·³è½¬ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹è‡ªå·±å»è·Ÿä¸€éæºç å¾ˆå¿«å°±äº†è§£æ¸…æ¥šäº†

# å››ã€ç»“è¯­

æœ¬ç¯‡æ–‡ç« ç¨å¾®æœ‰ç‚¹é•¿ï¼Œä»ç¡¬ä»¶é©±åŠ¨ï¼Œç³»ç»Ÿå†…æ ¸ï¼Œåˆ° Framework éƒ½æœ‰æ¶‰åŠ

åœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬ç”¨å¼ å¤§ä¼Ÿè€å¸ˆ[ã€Šæ·±å…¥ç†è§£Android å·IIIã€‹](https://book.douban.com/subject/26598458/)ä¹¦ä¸­çš„ä¸€æ®µè¯ä½œä¸ºæœ¬æ–‡æ€»ç»“ï¼š

ç®€å•æ¥è¯´ï¼Œå†…æ ¸å°†åŸå§‹äº‹ä»¶å†™å…¥åˆ°è®¾å¤‡æ–‡ä»¶ä¸­ï¼ŒInputReader ä¸æ–­åœ°é€šè¿‡ EventHub å°†åŸå§‹äº‹ä»¶å–å‡ºæ¥ï¼Œè§£æåŠ å·¥æˆ KeyEventã€MotionEvent äº‹ä»¶ï¼Œç„¶åäº¤ç»™ InputDispatcher

InputDispatcher æ ¹æ® WMS æä¾›çš„çª—å£ä¿¡æ¯å°†äº‹ä»¶äº¤ç»™åˆé€‚çš„çª—å£

æ¥ç€ï¼Œçª—å£çš„ ViewRootImpl å¯¹è±¡å†æ²¿ç€æ§ä»¶æ ‘å°†äº‹ä»¶æ´¾å‘ç»™æ„Ÿå…´è¶£çš„æ§ä»¶ï¼Œæ§ä»¶å¯¹å…¶æ”¶åˆ°çš„äº‹ä»¶ä½œå‡ºå“åº”ï¼Œæ›´æ–°è‡ªå·±çš„ç”»é¢ã€æ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œ

æ‰€æœ‰è¿™äº›å‚ä¸è€…ä»¥ IMS ä¸ºæ ¸å¿ƒï¼Œæ„å»ºäº† Android åºå¤§è€Œå¤æ‚çš„è¾“å…¥ä½“ç³»ã€‚

å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±å…¨éƒ¨ç»“æŸäº†ã€‚æ–‡ä¸­æåˆ°çš„ç¡¬ä»¶é©±åŠ¨å’Œç³»ç»Ÿå†…æ ¸è¿™ä¸¤å—æš‚æ—¶è¿˜ä¸æ˜¯æˆ‘æ“…é•¿çš„é¢†åŸŸï¼Œæ‰€ä»¥å¦‚æœå„ä½å¤§ä½¬å‘ç°æœ¬æ–‡æœ‰å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜æœ›åŠæ—¶æŒ‡å‡ºï¼Œæˆ‘ä¼šç¬¬ä¸€æ—¶é—´æ”¹æ­£ï¼Œæ„Ÿè°¢

å¦å¤–ï¼Œæ¬¢è¿å„ä½å¤§ä½¬ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ¢è®¨æŠ€æœ¯é—®é¢˜

**å…¨æ–‡å®Œ**

# äº”ã€å‚è€ƒèµ„æ–™

- [ã€Šæ·±å…¥ç†è§£Android å·III - å¼ å¤§ä¼Ÿã€‹](https://book.douban.com/subject/26598458/)
- [ç”µé˜»å±å·²ç»è¢«æ™ºèƒ½æ‰‹æœºæŠ›å¼ƒï¼Œè¿˜æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ](https://rohm.eefocus.com/article/id-317)
- [æ‰‹æœºå…¨è´´åˆå±å¹•æŠ€æœ¯è§£æ](https://blog.csdn.net/weixin_51554164/article/details/124965131)
- [ã€Linuxé©±åŠ¨ã€‘I2Cå­ç³»ç»Ÿä¸è§¦æ‘¸å±é©±åŠ¨ - @hongZ](https://blog.csdn.net/qq_39797956/article/details/118863217)
- [ã€Linuxé©±åŠ¨ã€‘inputå­ç³»ç»Ÿä¸æŒ‰é”®é©±åŠ¨ - @hongZ](https://blog.csdn.net/qq_39797956/article/details/117898095)
- [Linuxé©±åŠ¨å¼€å‘|inputå­ç³»ç»Ÿ - å®‰è¿ªè¥¿](https://blog.csdn.net/Chuangke_Andy/article/details/122181549)
- [ä» 0 å¼€å§‹å­¦ Linux é©±åŠ¨å¼€å‘ - Hcamael](https://paper.seebug.org/779/)
- [Android(Linux) è¾“å…¥å­ç³»ç»Ÿè§£æ - Andy Lee](http://huaqianlee.github.io/2017/11/23/Android/Android-Linux-input-system-analysis/)
- [Android å¦‚ä½•ä¸ŠæŠ¥ Touchevent ç»™åº”ç”¨å±‚ - è‘£åˆš](https://dqdongg.com/c/touch/android/2014/07/10/Touch-inputevent.html)
- [è¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾) - ä¼¤å¿ƒçš„çŒªå¤§è‚ ](https://juejin.cn/post/6925336861137174541)
- [Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆä¸€ï¼‰ä»å†…æ ¸åˆ°åº”ç”¨ ä¸€åˆ‡çš„å¼€å§‹ - å´è¿ª](https://www.viseator.com/2017/09/14/android_view_event_1/)
- [Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆäºŒï¼‰åŸå§‹äº‹ä»¶æ¶ˆæ¯ä¼ é€’ä¸åˆ†å‘çš„å¼€å§‹ - å´è¿ª](https://www.viseator.com/2017/10/07/android_view_event_2/)
- [Androidäº‹ä»¶åˆ†å‘æœºåˆ¶äºŒï¼šæ ¸å¿ƒåˆ†å‘é€»è¾‘æºç è§£æ - ä¸€åªä¿®ä»™çš„çŒ¿](https://juejin.cn/post/6920883974952714247)
- [InputChannel and InputDispatcher in Android](https://xianzhu21.space/developer/inputchannel_inputdispatcher)
