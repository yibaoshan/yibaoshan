
XV6 是 Unix-like 系统，特点之一它是宏内核，也就是操作系统的服务也是运行在内核空间，而不是用户空间。系统启动时，需要把内核代码都加载到内核空间。

# overview of xv6 lec 03

本章要介绍的是操作系统的组织结构，主要讨论 4 个问题：

1. Isolation，系统的隔离性。
2. Kernel 和 User mode，还是讲隔离，这两种模式用来隔离操作系统内核和用户应用程序。
3. System calls，用户程序怎么样才能调用内核程序。
4. 最后是 xv6 怎么实现这种思想的。

# 操作系统的隔离性 Isolation

介绍一下隔离性（isolation），以及介绍为什么它很重要，为什么我们需要关心它？

- 主要处于系统和应用程序的安全性考虑。
- 操作系统不是直接将CPU提供给应用程序，而是向应用程序提供“进程”，进程抽象了CPU，这样操作系统才能在多个应用程序之间复用一个或者多个CPU。
- Cache affinity，CPU 亲和性，将一个进程"绑定" 到一个或一组CPU上，尽量减少 Cache Miss。

# 操作系统防御性（Defensive）

介绍操作系统为什么应该具备防御性，其实也是处于安全角度考虑。

- 强隔离性必须有硬件的配合，后面会详细介绍。
  - 第一部分是 user/kernel mode
  - 第二部分是 page table 或者虚拟内存（Virtual Memory）。

以上，所有的处理器，如果需要运行能够支持多个应用程序的操作系统，需要同时支持 user/kernel mode 和虚拟内存

# 硬件对于强隔离的支持

为了支持 user/kernel mode，处理器会有两种操作模式

第一种是 user mode，第二种是kernel mode。

- 当运行在kernel mode时，CPU可以运行特定权限的指令（privileged instructions）；
- 当运行在user mode时，CPU只能运行普通权限的指令（unprivileged instructions）；

普通权限的指令都是一些你们熟悉的指令，例如：

- 将两个寄存器相加的指令ADD
- 将两个寄存器相减的指令SUB
- 跳转指令JRC
- BRANCH指令等等

这些都是普通权限指令，所有的应用程序都允许执行这些指令。

特殊权限指令主要是一些直接操纵硬件的指令和设置保护的指令，例如：

- 设置 page table寄存器
- 关闭时钟中断

在处理器上有各种各样的状态，操作系统会使用这些状态，但是只能通过特殊权限指令来变更这些状态。

虚拟内存篇

- 处理器包含了 page table，而 page table 将虚拟内存地址与物理内存地址做了对应。

- 如何实现操作系统接口？