# Lec 21 Networking

### 一、物理层 光/电信号

位于物理层的网卡的帧结构处理，网卡的工作是：

- 主要由网卡硬件（内部电路）处理
- 包括前导码、SFD 的添加和识别
- 信号的编码和解码
- 电平转换和时钟同步

同时，网卡也会有驱动程序，负责：

- 初始化网卡硬件
- 配置网卡参数（如 MAC 地址、工作模式）
- 管理发送和接收队列
- 处理中断
- 与操作系统的网络协议栈交互

如果不考虑以太网协议啥的，两台有网卡的设备之间通过一根网线直接连接（类似于两个串口直连），就可以互相传递信号了。

### 二、数据链路层 以太网协议

在两台设备，通过网线相连，能互相发送数据，的基础上，增加为，多台设备之间需要互相通信

1. 需要为每台设备新增一个唯一 ID，用于身份标识，也就是现在的 MAC 地址。
2. 需要创建一个规则/协议，用于区分谁和谁通信，现在一般都是以太网（Ethernet）协议。
   - 不过，以太网不只是一份基本协议，它是一套完整的解决方案
   - 它包含了物理层和数据链路层的规范，比如，使用 MAC 地址和数据帧格式 frame

多台设备之间，有好几种连接方式：

1. 总线型（Bus）：所有设备共享一条通信线路，结构简单，成本低，但容易发生冲突，一个设备故障可能影响整个网络
   ```plaintext
   设备A ─┬─ 设备B ─┬─ 设备C
          │         │
       共享总线    共享总线
    ```
2. 星型（Star）：所有设备连接到中心节点，容易管理，性能好，单台设备挂了不影响其他设备，缺点是如果交换机挂了网络就没了
   ```plaintext
   设备A ─┐
   设备B ─┼─ 交换机/集线器
   设备C ─┘
    ```
3. 环形（Ring）：Token Ring 网络使用这种方式，不考虑
   ```plaintext
   设备A ──→ 设备B
   ↑          ↓
   设备D ←── 设备C
    ```

现在基本都使用星型连接方式，多个设备之间，通过网线和 交换机/集线器 连接，当然现在基本上都是交换机

集线器的工作方式是：

1. 多个设备和集线器连接
2. 设备发送数据（目标地址 + 自己是谁 + 数据）给集线器
3. 集线器相当于村口、学校、商场里面的大喇叭，自己不处理数据，收到以后大喇叭通知给介入它的所有设备，谁谁谁发消息要找谁谁谁，这个数据包你看看你要不要？

交换机内部会维护一个 MAC 表，记录了每个设备对应的 MAC 地址，当收到数据时，会根据 MAC 地址找到对应的设备，将数据转发给该设备。首次收到数据 MAC 表为空的情况设计到 IP 地址下一小节介绍。

因为增加了 唯一 ID ：MAC 地址 的关系，所以，在数据链路层及以后的通信，每个数据包都必须要包含 目标 MAC 地址 和 源 MAC 地址，这样，集线器/交换机才可以根据 MAC 地址找到对应的设备，将数据转发给该设备。

```
物理层部分：
+----------+-----+
| 前导码    | SFD |  8字节
| 7字节     | 1字节|
+----------+-----+

数据链路层帧：
+----------+----------+----------+------------+--------+
| 目标MAC  | 源MAC    | 类型/长度 | 数据       | CRC    |
| 6字节    | 6字节    | 2字节    | 46-1500字节| 4字节  |
+----------+----------+----------+------------+--------+
```

- 最小帧：64字节
  - MAC地址：12字节
  - 类型：2字节
  - 数据：最少46字节
  - CRC：4字节
- 最大帧：1518字节
  - MAC地址：12字节
  - 类型：2字节
  - 数据：最多1500字节（MTU）
  - CRC：4字节

```
Frame（信封）：
+-----------------+------------------+------------------+
| 目标MAC（收件人） | 源MAC（寄件人）   | Packet（信件）    |
+-----------------+------------------+------------------+
                                    |
Packet（信件）：                      ↓
                  +----------------+------------------+
                  | IP地址（详细地址）|  数据（信件内容）  |
                  +----------------+------------------+
```

### 三、网络层 IP 协议

1. 两台设备之间，通过网线连接，可以互相通信。
2. 多台设备之间，通过交换机连接，形成一个局域网，局域网之间可以互相通信。

现在，在上面这两条的基础上，增加为，局域网之间也可以互相通信，局域网之间距离可能很远，相差十万八千里，摆在面前的有两个选择：

1. 继续用 Mac 地址，另外再创建一个 全球的交换机中心，每台交换机都通过一根网线连接在上面，这样交换机之间就可以互相通信了。
2. 增加额外的设备和协议

```
局域网A                    局域网B
设备1 ──┐               设备3 ──┐
设备2 ──┼── 交换机A     设备4 ──┼── 交换机B
        |                      |
        └──────  ??? ─────────┘
```



```
+-------+-------+---------------+-------------------------+
| 版本  | 首部  | 服务类型      | 总长度                  |
| 4位   | 长度  | (TOS) 8位    | 16位                   |
|       | 4位   |              |                        |
+-------+-------+---------------+-------------------------+
| 标识（16位）                  | 标志 | 片偏移            |
|                              | 3位  | 13位             |
+----------------------------------+--------------------+
| 生存时间      | 协议           | 首部校验和             |
| (TTL) 8位    | 8位           | 16位                   |
+---------------+---------------+-------------------------+
| 源IP地址（32位）                                       |
+-------------------------------------------------------+
| 目的IP地址（32位）                                     |
+-------------------------------------------------------+
| 选项（如果有）                                         |
+-------------------------------------------------------+
| 数据部分                                              |
| （长度可变）                                           |
+-------------------------------------------------------+
```

```
应用程序 → 协议栈 → 驱动程序 → 网卡硬件 → 物理网络
```

