
# è§†é¢‘ç¬”è®°

- satp å¯„å­˜å™¨ä¿å­˜çš„åœ°å€æ˜¯ç‰©ç†åœ°å€ã€‚
- mmu è½¬æ¢æ—¶ï¼Œæ˜¯åŽ»å†…å­˜é‡Œé¢ç‰©ç†åœ°å€ã€‚

è™šæ‹Ÿåœ°å€è½¬ä¸ºç‰©ç†åœ°å€

- å†…å­˜é¡µå¤§å°ä¸º 4KB = 4 * 1025Byte * 8Bit = 4096 ä¸ªæ¯”ç‰¹ä½ï¼Œä¸€èˆ¬ç»å¤§å¤šæ•° CPU éƒ½ä½¿ç”¨æˆ–è€…æ”¯æŒ 4KB åˆ†é¡µã€‚
- åœ¨å®žé™…çš„ç‰©ç†å†…å­˜ä¸­ï¼Œå†…å­˜é¡µæ˜¯æœ€å°é¢—ç²’åº¦ï¼Œå®ƒç»å¯¹æ˜¯è¿žç»­çš„ä¸€æ®µç‰©ç†å†…å­˜ã€‚
- risc-v å¯„å­˜å™¨éƒ½æ˜¯ 64 ä½ï¼Œä½†æ˜¯ï¼Œmmu ä»…ç”¨äº†å…¶ä¸­çš„ 39 ä½ï¼Œå‰ 25 ä½æ˜¯ç©ºç€çš„æ²¡ç”¨ï¼ŒåŽé¢çš„ 39 ä½åˆåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†
  - å‰ 27 ä½è¡¨ç¤ºè¿™ä¸ªç‰©ç†åœ°å€å…·ä½“åœ¨å“ªä¸€é¡µï¼ˆ4KB/é¡µï¼‰
  - åŽ 12 ä½æ˜¯åç§»é‡ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸€é¡µçš„å“ªä¸ª Bitã€‚
- åŸºäºŽä»¥ä¸Šï¼Œé—®å¤§å®¶ä¸€ä¸ªé—®é¢˜ï¼šSV 39 çš„å¯»å€æ–¹å¼æ”¯æŒçš„æœ€å¤§çš„è™šæ‹Ÿå†…å­˜æ˜¯å¤šå¤§ï¼Ÿ
- ç­”æ¡ˆæ˜¯ 2 çš„ 27 æ¬¡æ–¹å†ä¹˜ä¸Šé¡µå¤§å° 2^27 * 4KB = 512GBã€‚
- risc-v æ”¯æŒçš„ç‰©ç†å†…å­˜å¤§å°æ˜¯ 2^56 = 32PB
- MMU of CPU or Mainboard
  - è™šæ‹Ÿå†…å­˜åœ°å€ 39 ä½ï¼Œç‰©ç†åœ°å€ 56 ä½ã€‚
  - æŠ›å¼€æœ€åŽä½Ž 12 ä½çš„ offsetï¼Œè™šæ‹Ÿåœ°å€ 27 ä½ï¼Œç‰©ç†åœ°å€ 44 ä½ã€‚
  - ä¹Ÿå°±æ˜¯è¯´ï¼ŒMMU éœ€è¦æŠŠ 27 ä½çš„åœ°å€ï¼Œè½¬æ¢æˆ 44 ä½ã€‚æ€Žä¹ˆåšå‘¢ï¼Ÿ
- é¡µè¡¨
  - ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œé¡µè¡¨æ˜¯ä¸€å—å†…å­˜ï¼Œè§„å®šå¤§å°æ˜¯ 8kb
  - MMU ä¸‰çº§é¡µè¡¨ï¼Œéœ€è¦æ‰¾ä¸‰æ¬¡ã€‚
  - é€šè¿‡ç¬¬ä¸€çº§æ‰¾åˆ°ç¬¬äºŒçº§
  - satp å¯„å­˜å™¨ä¿å­˜çš„æ˜¯ç¬¬ä¸€çº§çš„ç‰©ç†åœ°å€ï¼Œå½“éœ€è¦åˆ‡æ¢è¿›ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå†™å…¥è¯¥è¿›ç¨‹å¯¹åº”çš„ç¬¬ä¸€çº§åˆ—è¡¨çš„ç‰©ç†åœ°å€åˆ° satp å¯„å­˜å™¨
  - å†™å…¥ satp å¯„å­˜å™¨æ˜¯å—ä¿æŠ¤çš„ç‰¹æƒçº§æŒ‡ä»¤ï¼Œç”¨æˆ·ç¨‹åºæ— æ³•æ›´æ”¹ satp å¯„å­˜å™¨çš„å€¼ã€‚

# ç–‘é—®â“

è¯¥åº”ç”¨è¿åäº†å¼€å‘è€…æ”¿ç­–ï¼Œä½¿ç”¨äº†ç¬¬ä¸‰æ–¹æ”¯ä»˜æ–¹å¼ï¼Œå°†ç”¨æˆ·å¼•å¯¼è‡³ Google Play ç»“ç®—ç³»ç»Ÿä»¥å¤–çš„ç³»ç»Ÿã€‚

è§¦å‘æ–¹å¼ï¼š

1. æ³¨å†Œç”·ç”¨æˆ·å¹¶ç™»å…¥ï¼Œå’Œå†…éƒ¨çš„ AI èŠå¤©åŽè§¦å‘è´­ä¹°ä¼šå‘˜æˆ–è€…è´­ä¹°èŠå¤©æ¬¡æ•°ã€‚
2. å†è¿žç»­ä»˜æ¬¾ä¸¤æ¬¡ä»¥åŽï¼Œå¯èƒ½ä¼šè§¦å‘ç¬¬ä¸‰æ–¹æ”¯ä»˜ç³»ç»Ÿã€‚
3. ç¬¬ä¸‰æ–¹æ”¯ä»˜ç³»ç»Ÿä½¿ç”¨ WebView é¡µé¢ï¼Œä¹Ÿå¯ä»¥è·³å‡ºåº”ç”¨åˆ°æµè§ˆå™¨ç»“ç®—ã€‚

- mmu è½¬æ¢è¿‡ç¨‹ï¼Ÿä¸‰çº§ç›®å½•
- ä¸‰çº§é¡µè¡¨ï¼Œæ¯ä¸ªé¡µè¡¨çš„å¤§å°æ˜¯å¤šå°‘ï¼Ÿ

# è¯¾å‰è¦æ±‚

1. é˜…è¯» book-riscv-rev1 ç¬¬ä¸‰ç« ï¼Œpage tables
2. é˜…è¯»éƒ¨åˆ† kernel æºç ï¼š
   1. https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/memlayout.h
   2. https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/vm.c
   3. https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/kalloc.c
   4. https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/riscv.h
   5. https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/exec.c

### page tables of book-riscv-rev1

è®©äººå¤´ç–¼çš„ç¡¬ä»¶åˆ†é¡µæœºåˆ¶

- user/kernel model å·²ç»è§£å†³äº†éš”ç¦»æ€§ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦åˆ†é¡µï¼Ÿ
  - User/Kernel Modeï¼šè§£å†³â€œä»£ç èƒ½åšä»€ä¹ˆâ€
  - åˆ†é¡µï¼šè§£å†³â€œä»£ç èƒ½è®¿é—®å“ªäº›å†…å­˜â€
  - äºŒè€…ç¼ºä¸€ä¸å¯ï¼šå³ä½¿ç¨‹åºåœ¨ç”¨æˆ·æ€ï¼Œè‹¥æ²¡æœ‰åˆ†é¡µï¼Œä¹Ÿå¯èƒ½é€šè¿‡é‡ŽæŒ‡é’ˆç ´åå…¶ä»–è¿›ç¨‹æˆ–å†…æ ¸ã€‚
- è®¿é—®å†…å­˜ä¼šé‰´æƒï¼Œé¿å…éžæ³•è®¿é—®ï¼Œä¸ºä»€ä¹ˆéœ€è¦åˆ†é¡µï¼Ÿ
- æ¶‰åŠåˆ°çš„ç¡¬ä»¶ or å¯„å­˜å™¨æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æœ‰å“ªäº›ä½œç”¨ï¼Ÿ
  - satpï¼ˆSupervisor Address Translation and Protectionï¼‰å¯„å­˜å™¨æ˜¯æŽ§åˆ¶é¡µè¡¨çš„æ ¸å¿ƒå¯„å­˜å™¨ã€‚

Sv39 RISC-V çš„åˆ†é¡µæœºåˆ¶ï¼ˆä¸‰çº§é¡µè¡¨ï¼‰ï¼Œè™šæ‹Ÿåœ°å€ç»“æž„ï¼ˆå…± 39 ä½ï¼Œæ”¯æŒ 512GB è™šæ‹Ÿç©ºé—´ï¼‰ï¼Œé¡µè¡¨é¡¹ï¼ˆPTE, Page Table Entryï¼‰å  8 å­—èŠ‚

| ä¸€çº§ç›®å½•å·ï¼ˆ9ä½ï¼‰ | äºŒçº§ç›®å½•å·ï¼ˆ9ä½ï¼‰ | ä¸‰çº§ç›®å½•å·ï¼ˆ9ä½ï¼‰ | é¡µå†…åç§»ï¼ˆ12ä½ï¼‰ |

æ¯ä¸€çº§ç›®å½•å·ç”¨æ¥ç´¢å¼•é¡µè¡¨ï¼Œæœ€åŽ 12 ä½æ˜¯é¡µå†…åç§»ï¼ˆå› ä¸ºæ¯é¡µå¤§å°æ˜¯ 4KB = 2^12ï¼‰ã€‚

ä¸¾ä¸ªæ —å­ ðŸŒ°ï¼š

å‡è®¾ç¨‹åºè¦è®¿é—®è™šæ‹Ÿåœ°å€ 0x12345678ï¼Œç¡¬ä»¶ä¼šè¿™æ ·æŸ¥ 

- ä¸€çº§é¡µè¡¨ï¼šç”¨å‰ 9 ä½ï¼ˆæ¯”å¦‚ 0x123ï¼‰æ‰¾åˆ°äºŒçº§é¡µè¡¨çš„ä½ç½®ã€‚ 
- äºŒçº§é¡µè¡¨ï¼šç”¨ä¸­é—´ 9 ä½ï¼ˆæ¯”å¦‚ 0x456ï¼‰æ‰¾åˆ°ä¸‰çº§é¡µè¡¨çš„ä½ç½®ã€‚ 
- ä¸‰çº§é¡µè¡¨ï¼šç”¨æœ€åŽ 9 ä½ï¼ˆæ¯”å¦‚ 0x78ï¼‰æ‰¾åˆ°æœ€ç»ˆçš„ç‰©ç†é¡µå·ã€‚ 
- æ‹¼å‡ºç‰©ç†åœ°å€ï¼šç‰©ç†é¡µå· + é¡µå†…åç§»ï¼ˆæœ€åŽ 12 ä½ï¼‰ã€‚

### memlayout.h

https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/memlayout.h

å®šä¹‰äº† xv6 å†…å­˜å¸ƒå±€çš„ç›¸å…³å¸¸é‡å’Œå®ï¼Œå¸®åŠ©æ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜

- KERNBASEï¼šè¿™æ˜¯å†…æ ¸å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œé€šå¸¸å®ƒåœ¨ 32-bit ç³»ç»Ÿä¸­ä¸º 0x80000000ï¼Œæ„å‘³ç€å†…æ ¸å†…å­˜ä»Žè¿™ä¸ªåœ°å€å¼€å§‹ã€‚
- PHYSTOPï¼šè¿™æ˜¯ç‰©ç†å†…å­˜çš„ç»“æŸåœ°å€ï¼Œè¡¨ç¤ºæ“ä½œç³»ç»Ÿèƒ½å¤Ÿè®¿é—®çš„æœ€å¤§ç‰©ç†å†…å­˜åœ°å€ã€‚

### vm.c

å…³é”®å‡½æ•°åŒ…æ‹¬ï¼š 

- walkï¼šéåŽ†é¡µè¡¨ï¼Œè¿”å›žè™šæ‹Ÿåœ°å€å¯¹åº”çš„ PTEã€‚ 
- mappagesï¼šå°†ä¸€æ®µè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ã€‚ 
- uvmcreateï¼šä¸ºç”¨æˆ·è¿›ç¨‹åˆ›å»ºç©ºé¡µè¡¨ã€‚ 
- kvminitï¼šåˆå§‹åŒ–å†…æ ¸é¡µè¡¨ã€‚

å†…æ ¸é¡µè¡¨åˆå§‹åŒ–ï¼ˆkvminitï¼‰

```c
void kvminit() {
kernel_pagetable = (pagetable_t) kalloc();
memset(kernel_pagetable, 0, PGSIZE);
kvmmap(UART0, UART0, PGSIZE, PTE_R | PTE_W); // æ˜ å°„ UART è®¾å¤‡
kvmmap(VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W); // æ˜ å°„ VirtIO è®¾å¤‡
// ...
}
```

æ¯ä¸ªè¿›ç¨‹ï¼ˆstruct procï¼‰æœ‰è‡ªå·±çš„é¡µè¡¨ï¼ˆp->pagetableï¼‰ï¼Œåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ›´æ–° satp å¯„å­˜å™¨ï¼š

```c
void scheduler() {
// ...
w_satp(MAKE_SATP(p->pagetable)); // è®¾ç½® satp å¯„å­˜å™¨
sfence_vma(); // åˆ·æ–° TLB
// ...
}
```